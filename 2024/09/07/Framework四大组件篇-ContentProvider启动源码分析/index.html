<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Framework四大组件篇-ContentProvider启动源码分析 | Android高级直通车</title><meta name="author" content="王征"><meta name="copyright" content="王征"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="目录 一、ContentProvider基本使用 （1）介绍下ContentProvider、ContentResolver、ContentObserver三者关系 （2）服务端ContentProvider 1、数据库操作类 2、自定义 ContentProvider 3、AndroidManifest配置   （3）客户端ContentResolver （4）监听端ContentObserve">
<meta property="og:type" content="article">
<meta property="og:title" content="Framework四大组件篇-ContentProvider启动源码分析">
<meta property="og:url" content="https://irving18.github.io/2024/09/07/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-ContentProvider%E5%90%AF%E5%8A%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Android高级直通车">
<meta property="og:description" content="目录 一、ContentProvider基本使用 （1）介绍下ContentProvider、ContentResolver、ContentObserver三者关系 （2）服务端ContentProvider 1、数据库操作类 2、自定义 ContentProvider 3、AndroidManifest配置   （3）客户端ContentResolver （4）监听端ContentObserve">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://irving18.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2024-09-07T07:39:36.000Z">
<meta property="article:modified_time" content="2024-12-27T09:07:01.620Z">
<meta property="article:author" content="王征">
<meta property="article:tag" content="Android进阶">
<meta property="article:tag" content="Framework">
<meta property="article:tag" content="四大组件">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://irving18.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="https://irving18.github.io/2024/09/07/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-ContentProvider%E5%90%AF%E5%8A%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Framework四大组件篇-ContentProvider启动源码分析',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">41</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/bg.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Android高级直通车</span></a><a class="nav-page-title" href="/"><span class="site-name">Framework四大组件篇-ContentProvider启动源码分析</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Framework四大组件篇-ContentProvider启动源码分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-09-07T07:39:36.000Z" title="发表于 2024-09-07 15:39:36">2024-09-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-12-27T09:07:01.620Z" title="更新于 2024-12-27 17:07:01">2024-12-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android%E8%BF%9B%E9%98%B6/">Android进阶</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">3.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>16分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><ul>
<li><a href="#jump1">一、ContentProvider基本使用</a><ul>
<li><a href="#jump1_1">（1）介绍下ContentProvider、ContentResolver、ContentObserver三者关系</a></li>
<li><a href="#jump1_2">（2）服务端ContentProvider</a><ul>
<li><a href="#jump1_2_1">1、数据库操作类</a></li>
<li><a href="#jump1_2_2">2、自定义 ContentProvider</a></li>
<li><a href="#jump1_2_3">3、AndroidManifest配置</a></li>
</ul>
</li>
<li><a href="#jump1_3">（3）客户端ContentResolver</a></li>
<li><a href="#jump1_4">（4）监听端ContentObserver</a></li>
</ul>
</li>
<li><a href="#jump2">二、ContentProvider启动原理</a><ul>
<li><a href="#jump2_0">引言</a></li>
<li><a href="#jump2_1">（1）完整时序图</a></li>
<li><a href="#jump2_2">（2）ActivityThread.bindApplication()</a></li>
<li><a href="#jump2_3">（3）ActivityThread.installContentProviders()</a><ul>
<li><a href="#jump2_4">3.1 ActivityThread.installProvider()通过反射，创建ContentProvider对象</a></li>
<li><a href="#jump2_5">3.2 AMS.publishContentProviders()发布到AMS中</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#jump3">三、ContentProvider查询原理</a><ul>
<li><a href="#jump3_1">（1）完整查询过程</a></li>
<li><a href="#jump3_2">（2）服务端：发布ContentProvider</a></li>
<li><a href="#jump3_3">（3）客户端：ActivityThread.installProvider()获取ContentProviderProxy</a></li>
<li><a href="#jump3_4">（4）客户端：与ContentProviderNative进行binder通信query()查询数据</a></li>
</ul>
</li>
<li><a href="#jump4">四、ContentProvider服务端两种情况下的查询原理</a><ul>
<li><a href="#jump4_1">（1）服务端未启动</a></li>
<li><a href="#jump4_2">（2）服务端已启动</a></li>
</ul>
</li>
<li><a href="#jump5">五、总结</a><ul>
<li><a href="#jump5">（1）ContentProvider交互原理</a></li>
<li><a href="#jump5">（2）AMS在ContentProvider注册好，notify线程时调用客户端App的installProvider()</a></li>
</ul>
</li>
<li><a href="">参考链接</a><ul>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/7207065292026937381?searchId=2024062211425849D5872F35CBA4F721C0#heading-5">使用篇</a></li>
<li><a target="_blank" rel="noopener" href="https://lrc19860926.medium.com/android%E4%B8%ADcontentprovider%E7%9A%84%E5%90%AF%E5%8A%A8%E4%B8%8E%E8%AF%B7%E6%B1%82%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3-aa592051b2b7">启动与请求源码流程详解</a></li>
<li><a target="_blank" rel="noopener" href="https://note.youdao.com/s/4RPvcIjk">huayi备份</a></li>
<li><a target="_blank" rel="noopener" href="https://gityuan.com/2016/07/30/content-provider/">gityuan1</a></li>
<li><a target="_blank" rel="noopener" href="https://gityuan.com/2017/06/04/content_provider_record/">gityuan2</a></li>
<li><a target="_blank" rel="noopener" href="https://gityuan.com/2016/05/03/content_provider_release/">gityuan3</a></li>
</ul>
</li>
</ul>
<h1 id="一、ContentProvider基本使用"><a href="#一、ContentProvider基本使用" class="headerlink" title="一、ContentProvider基本使用"></a><span id="jump1"/>一、ContentProvider基本使用</h1><h2 id="（1）介绍下ContentProvider、ContentResolver、ContentObserver三者关系"><a href="#（1）介绍下ContentProvider、ContentResolver、ContentObserver三者关系" class="headerlink" title="（1）介绍下ContentProvider、ContentResolver、ContentObserver三者关系"></a><span id="jump1_1"/>（1）介绍下ContentProvider、ContentResolver、ContentObserver三者关系</h2><p><img src="https://raw.githubusercontent.com/IRVING18/pic/master/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-ContentProvider%E5%90%AF%E5%8A%A8_1.jpg" alt="image.png"><br><img src="https://raw.githubusercontent.com/IRVING18/pic/master/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-ContentProvider%E5%90%AF%E5%8A%A8_2.jpg" alt="image.png"></p>
<p>两张图就已经描述的很清楚了，</p>
<ul>
<li>ContentProvider <ul>
<li>通常属于服务端，</li>
<li>提供更改数据库、SP、文件等等，属于服务端App的数据；</li>
</ul>
</li>
<li>ContentResolver <ul>
<li>用于客户端，</li>
<li>即其他App想改 服务端的数据，例如联系人信息等等；</li>
</ul>
</li>
<li>ContentObserver <ul>
<li>通常用于监听的，也可以说是客户端；</li>
<li>比如app做了一个类似联系人的应用，它想实时监听联系人的变化情况，就可以用这个；</li>
</ul>
</li>
</ul>
<h3 id="1、ContentProvider-接口"><a href="#1、ContentProvider-接口" class="headerlink" title="1、ContentProvider 接口"></a>1、ContentProvider 接口</h3><p>ContentProvider 是一个抽象类，用户需要实现如下抽象方法。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建数据库并获得数据库连接</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> boolean onCreate()</span><br><span class="line"><span class="comment">// 查询数据</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> Cursor query(Uri uri, String[] projection, String selection, String[] selectionArgs, String sortOrder)</span><br><span class="line"><span class="comment">// 插入数据</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> Uri insert(Uri uri, ContentValues values)</span><br><span class="line"><span class="comment">// 删除数据</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> int delete(Uri uri, String selection, String[] selectionArgs)</span><br><span class="line"><span class="comment">// 更新数据</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> int update(Uri uri, ContentValues values, String selection, String[] selectionArgs)</span><br><span class="line"><span class="comment">// 获取数据类型（MIME类型，如：&quot;text/html&quot;、&quot;image/png&quot;、&quot;message/rfc882&quot;、&quot;vnd.android-dir/mms-sms&quot;）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> String getType(Uri uri)</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<ul>
<li>uri：数据表路径</li>
<li>projection：需要查询的字段名称</li>
<li>selection：查询条件</li>
<li>selectionArgs：查询条件中的参数列表</li>
<li>sortOrder：排序</li>
</ul>
<h3 id="2、ContentResolver-接口"><a href="#2、ContentResolver-接口" class="headerlink" title="2、ContentResolver 接口"></a>2、ContentResolver 接口</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询数据</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Cursor query(Uri uri, String[] projection, String selection, String[] selectionArgs, String sortOrder)</span><br><span class="line"><span class="comment">// 插入数据</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> Uri insert(Uri url, ContentValues values)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> int delete(Uri url, String selection, String[] selectionArgs)</span><br><span class="line"><span class="comment">// 更新数据</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> int update(Uri uri, ContentValues values, String selection, String[] selectionArgs)</span><br></pre></td></tr></table></figure>
<p>可以看到，ContentProvider 和 ContentResolver 都有增删改查操作，并且参数列表完全一致，以实现对 Server 端数据的操作。</p>
<h3 id="3、ContentObserver-接口"><a href="#3、ContentObserver-接口" class="headerlink" title="3、ContentObserver 接口"></a>3、ContentObserver 接口</h3><p>ContentObserver 是一个抽象类，用户需要重写其构造方法和 onChange() 方法。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用户需要重写构造方法，并注入 handler</span></span><br><span class="line"><span class="keyword">public</span> ContentObserver(Handler handler)</span><br><span class="line"></span><br><span class="line"><span class="comment">//监听的内容发生变化时调用</span></span><br><span class="line"><span class="keyword">public</span> void onChange(boolean selfChange)</span><br><span class="line"></span><br><span class="line"><span class="comment">//注册 ContentObserver</span></span><br><span class="line">mContext.getContentResolver().registerContentObserver(uri, <span class="literal">false</span>, observer);</span><br><span class="line"></span><br><span class="line"><span class="comment">//注销 ContentObserver</span></span><br><span class="line">mContext.getContentResolver().unregisterContentObserver(observer);</span><br></pre></td></tr></table></figure>

<h2 id="（2）服务端ContentProvider"><a href="#（2）服务端ContentProvider" class="headerlink" title="（2）服务端ContentProvider"></a><span id="jump1_2"/>（2）服务端ContentProvider</h2><h3 id="1、数据库操作类"><a href="#1、数据库操作类" class="headerlink" title="1、数据库操作类"></a><span id="jump1_2_1"/>1、数据库操作类</h3><p>DBHelper.java</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DBHelper</span> <span class="title">extends</span> <span class="title">SQLiteOpenHelper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> static <span class="keyword">final</span> String DATABASE = <span class="string">&quot;test.db&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> static <span class="keyword">final</span> String TABLE = <span class="string">&quot;user&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> DBHelper(Context context) &#123;</span><br><span class="line">        <span class="keyword">super</span>(context, DATABASE, <span class="literal">null</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> void onCreate(SQLiteDatabase db) &#123;</span><br><span class="line">        String create_table = <span class="string">&quot;create table &quot;</span> + TABLE + <span class="string">&quot;(id int primary key, name varchar not null)&quot;</span>;</span><br><span class="line">        db.execSQL(create_table);</span><br><span class="line">        db.execSQL(<span class="string">&quot;insert into &quot;</span> + TABLE + <span class="string">&quot; values(1001, &#x27;张三&#x27;),(1002, &#x27;李四&#x27;)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Cursor query() &#123;</span><br><span class="line">        SQLiteDatabase db = getReadableDatabase();</span><br><span class="line">        String sql = <span class="string">&quot;select * from &quot;</span> + TABLE;</span><br><span class="line">        Cursor cursor = db.rawQuery(sql, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">return</span> cursor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> long insert(ContentValues cv) &#123;</span><br><span class="line">        SQLiteDatabase db = getWritableDatabase();</span><br><span class="line">        long result = db.insert(TABLE, <span class="literal">null</span>, cv);</span><br><span class="line">        db.close();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成的数据库如下：<br><img src="https://raw.githubusercontent.com/IRVING18/pic/master/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-ContentProvider%E5%90%AF%E5%8A%A8_3.jpg" alt="image.png"></p>
<h3 id="2、自定义-ContentProvider"><a href="#2、自定义-ContentProvider" class="headerlink" title="2、自定义 ContentProvider"></a><span id="jump1_2_2"/>2、自定义 ContentProvider</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyProvider</span> <span class="title">extends</span> <span class="title">ContentProvider</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> DBHelper mUserDBHelper;</span><br><span class="line">    <span class="keyword">private</span> static UriMatcher sUriMatcher = new UriMatcher(UriMatcher.NO_MATCH); <span class="comment">//用于匹配URI，并返回对应的操作编码</span></span><br><span class="line">    <span class="keyword">private</span> static <span class="keyword">final</span> String AUTHORITES = <span class="string">&quot;com.zhyan8.content.MyProvider&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> static <span class="keyword">final</span> int QUERY = <span class="number">1</span>; <span class="comment">//查询操作编码</span></span><br><span class="line">    <span class="keyword">private</span> static <span class="keyword">final</span> int INSERT = <span class="number">2</span>; <span class="comment">//插入操作编码</span></span><br><span class="line"></span><br><span class="line">    static &#123; <span class="comment">//添加有效的 URI 及其编码</span></span><br><span class="line">        sUriMatcher.addURI(AUTHORITES, <span class="string">&quot;/query&quot;</span>, QUERY);</span><br><span class="line">        sUriMatcher.addURI(AUTHORITES, <span class="string">&quot;/insert&quot;</span>, INSERT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> boolean onCreate() &#123;</span><br><span class="line">        mUserDBHelper = new DBHelper(getContext());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Cursor query(Uri uri, String[] projection, String selection, String[] selectionArgs, String sortOrder) &#123;</span><br><span class="line">        Log.e(<span class="string">&quot;xxx-Provider&quot;</span>, <span class="string">&quot;query: &quot;</span>);</span><br><span class="line">        int code = sUriMatcher.match(uri);</span><br><span class="line">        <span class="keyword">if</span> (code == QUERY) &#123;</span><br><span class="line">            <span class="keyword">return</span> mUserDBHelper.query();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Uri insert(Uri uri, ContentValues values) &#123;</span><br><span class="line">        Log.e(<span class="string">&quot;xxx-Provider&quot;</span>, <span class="string">&quot;insert: &quot;</span>);</span><br><span class="line">        int code = sUriMatcher.match(uri);</span><br><span class="line">        <span class="keyword">if</span> (code == INSERT) &#123;</span><br><span class="line">            mUserDBHelper.insert(values);</span><br><span class="line">        &#125;</span><br><span class="line">        getContext().getContentResolver().notifyChange(uri, <span class="literal">null</span>); <span class="comment">//通知外界，数据发生变化</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String getType(Uri uri) &#123; <span class="comment">//获取资源 MIME</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> int delete(Uri uri, String selection, String[] selectionArgs) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> int update(Uri uri, ContentValues values, String selection, String[] selectionArgs) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3、AndroidManifest配置"><a href="#3、AndroidManifest配置" class="headerlink" title="3、AndroidManifest配置"></a><span id="jump1_2_3"/>3、AndroidManifest配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:name</span>=<span class="string">&quot;.MyProvider&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:authorities</span>=<span class="string">&quot;com.zhyan8.content.MyProvider&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>exported 属性用于定义是否允许外界访问。</p>
<h2 id="（3）客户端ContentResolver"><a href="#（3）客户端ContentResolver" class="headerlink" title="（3）客户端ContentResolver"></a><span id="jump1_3"/>（3）客户端ContentResolver</h2><h3 id="1、实体类"><a href="#1、实体类" class="headerlink" title="1、实体类"></a>1、实体类</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    Integer id;</span><br><span class="line">    String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、自定义-ContentResolver"><a href="#2、自定义-ContentResolver" class="headerlink" title="2、自定义 ContentResolver"></a>2、自定义 ContentResolver</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyResolver</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> ContentResolver mContentResolver;</span><br><span class="line">    <span class="keyword">private</span> static <span class="keyword">final</span> String AUTHORITES = <span class="string">&quot;com.zhyan8.content.MyProvider&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> MyResolver(Context context) &#123;</span><br><span class="line">        mContentResolver = context.getContentResolver();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;User&gt; query() &#123;</span><br><span class="line">        ArrayList&lt;User&gt; list = new ArrayList&lt;&gt;();</span><br><span class="line">        Uri uri = Uri.parse(<span class="string">&quot;content://&quot;</span> + AUTHORITES + <span class="string">&quot;/query&quot;</span>);</span><br><span class="line">        Cursor cursor = mContentResolver.query(uri, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">while</span> (cursor.moveToNext()) &#123;</span><br><span class="line">            User user = new User();</span><br><span class="line">            user.setId(cursor.getInt(<span class="number">0</span>));</span><br><span class="line">            user.setName(cursor.getString(<span class="number">1</span>));</span><br><span class="line">            list.add(user);</span><br><span class="line">        &#125;</span><br><span class="line">        cursor.close();</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> void insert(User user) &#123;</span><br><span class="line">        Uri uri = Uri.parse(<span class="string">&quot;content://&quot;</span> + AUTHORITES + <span class="string">&quot;/insert&quot;</span>);</span><br><span class="line">        ContentValues cv = new ContentValues();</span><br><span class="line">        cv.put(<span class="string">&quot;id&quot;</span>, user.getId());</span><br><span class="line">        cv.put(<span class="string">&quot;name&quot;</span>, user.getName());</span><br><span class="line">        mContentResolver.insert(uri, cv);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="（4）监听端ContentObserver"><a href="#（4）监听端ContentObserver" class="headerlink" title="（4）监听端ContentObserver"></a><span id="jump1_4"/>（4）监听端ContentObserver</h2><h3 id="1、自定义-ContentObserver"><a href="#1、自定义-ContentObserver" class="headerlink" title="1、自定义 ContentObserver"></a>1、自定义 ContentObserver</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyObserver</span> <span class="title">extends</span> <span class="title">ContentObserver</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Uri mUri = Uri.parse(<span class="string">&quot;content://com.zhyan8.content.MyProvider/insert&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> ContentResolver mResolver;</span><br><span class="line">    Handler mHandler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> MyObserver(Context context, Handler handler) &#123;</span><br><span class="line">        <span class="keyword">super</span>(handler);</span><br><span class="line">        mResolver = context.getContentResolver();</span><br><span class="line">        mHandler = handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> void onChange(boolean selfChange) &#123;</span><br><span class="line">        mHandler.sendEmptyMessage(<span class="number">0x111</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> void registerObserver() &#123;</span><br><span class="line">        mResolver.registerContentObserver(mUri, <span class="literal">false</span>, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> void unregisterObserver() &#123;</span><br><span class="line">        mResolver.unregisterContentObserver(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先保证 Content_S、Content_C 和 Content_O 3个应用都打开了，再在 Content_C 端依次点击【查询】→【插入】→【查询】，打印日志如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">content_s E/xxx-Provider: query: 	</span><br><span class="line">content_c E/xxx: clickQuery: [User&#123;id=1001, name=&#x27;张三&#x27;&#125;, User&#123;id=1002, name=&#x27;李四&#x27;&#125;]</span><br><span class="line">content_s E/xxx-Provider: insert: </span><br><span class="line">content_o E/xxx: 监听的数据改变了</span><br><span class="line">content_s E/xxx-Provider: query: </span><br><span class="line">content_c E/xxx: clickQuery: [User&#123;id=1001, name=&#x27;张三&#x27;&#125;, User&#123;id=1002, name=&#x27;李四&#x27;&#125;, User&#123;id=1003, name=&#x27;王五&#x27;&#125;]</span><br></pre></td></tr></table></figure>


<h1 id="二、ContentProvider启动原理"><a href="#二、ContentProvider启动原理" class="headerlink" title="二、ContentProvider启动原理"></a><span id="jump2"/>二、ContentProvider启动原理</h1><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a><span id="jump2_0"/>引言</h2><p>在<a target="_blank" rel="noopener" href="https://note.youdao.com/ynoteshare/index.html?id=f50dbedb59d88411ba80e7359d6052fb&type=note&_time=1719034971981">AMS启动Activity流程</a>中，我们知道了在AMS.bindApplication()后，调用调到解析ContentProvider中；</p>
<p><img src="https://raw.githubusercontent.com/IRVING18/pic/master/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-ContentProvider%E5%90%AF%E5%8A%A8_4.jpg" alt="image.png"></p>
<h2 id="（1）完整时序图"><a href="#（1）完整时序图" class="headerlink" title="（1）完整时序图"></a><span id="jump2_1"/>（1）完整时序图</h2><p><img src="https://raw.githubusercontent.com/IRVING18/pic/master/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-ContentProvider%E5%90%AF%E5%8A%A8_5.jpg" alt="ContentProvider启动.png"></p>
<h2 id="（2）ActivityThread-bindApplication"><a href="#（2）ActivityThread-bindApplication" class="headerlink" title="（2）ActivityThread.bindApplication()"></a><span id="jump2_2"/>（2）ActivityThread.bindApplication()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># ActivityThread.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">bindApplication</span><span class="params">(...)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">AppBindData</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AppBindData</span>();</span><br><span class="line">    data.providers = providers;</span><br><span class="line">    ...</span><br><span class="line">    sendMessage(H.BIND_APPLICATION, data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当主线程收到H.BIND_APPLICATION消息后，会调用handleBindApplication方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handleBindApplication</span><span class="params">(AppBindData data)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    Process.setArgV0(data.processName); <span class="comment">//设置进程名</span></span><br><span class="line">    <span class="comment">//实例化app</span></span><br><span class="line">    <span class="type">Application</span> <span class="variable">app</span> <span class="operator">=</span> data.info.makeApplication(data.restrictedBackupMode, <span class="literal">null</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (!data.restrictedBackupMode) &#123;</span><br><span class="line">        List&lt;ProviderInfo&gt; providers = data.providers;</span><br><span class="line">        <span class="keyword">if</span> (providers != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//安装ContentProviders 【见小节(3)】</span></span><br><span class="line">            installContentProviders(app, providers);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//回调app.onCreate()</span></span><br><span class="line">    mInstrumentation.callApplicationOnCreate(app);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="（3）ActivityThread-installContentProviders"><a href="#（3）ActivityThread-installContentProviders" class="headerlink" title="（3）ActivityThread.installContentProviders()"></a><span id="jump2_3"/>（3）ActivityThread.installContentProviders()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">installContentProviders</span><span class="params">( Context context, List&lt;ProviderInfo&gt; providers)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;IActivityManager.ContentProviderHolder&gt; results =</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;IActivityManager.ContentProviderHolder&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ProviderInfo cpi : providers) &#123;</span><br><span class="line">        <span class="comment">// 安装provider 【见小节(3.1)】</span></span><br><span class="line">        IActivityManager.<span class="type">ContentProviderHolder</span> <span class="variable">cph</span> <span class="operator">=</span> installProvider(context, <span class="literal">null</span>, cpi,</span><br><span class="line">                <span class="literal">false</span> <span class="comment">/*noisy*/</span>, <span class="literal">true</span> <span class="comment">/*noReleaseNeeded*/</span>, <span class="literal">true</span> <span class="comment">/*stable*/</span>);</span><br><span class="line">        <span class="keyword">if</span> (cph != <span class="literal">null</span>) &#123;</span><br><span class="line">            cph.noReleaseNeeded = <span class="literal">true</span>;</span><br><span class="line">            results.add(cph);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 发布provider 【见小节(3.2)】</span></span><br><span class="line">        ActivityManagerNative.getDefault().publishContentProviders(</span><br><span class="line">            getApplicationThread(), results);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-1-ActivityThread-installProvider"><a href="#3-1-ActivityThread-installProvider" class="headerlink" title="3.1 ActivityThread.installProvider()"></a><span id="jump2_4"/>3.1 ActivityThread.installProvider()</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> IActivityManager.ContentProviderHolder installProvider(Context context, IActivityManager.ContentProviderHolder holder, ProviderInfo info, boolean noisy, boolean noReleaseNeeded, boolean stable) &#123;</span><br><span class="line">    ContentProvider localProvider = <span class="literal">null</span>;</span><br><span class="line">    IContentProvider provider;</span><br><span class="line">    <span class="keyword">if</span> (holder == <span class="literal">null</span> || holder.provider == <span class="literal">null</span>) &#123;</span><br><span class="line">        Context c = <span class="literal">null</span>;</span><br><span class="line">        ApplicationInfo ai = info.applicationInfo;</span><br><span class="line">        <span class="keyword">if</span> (context.getPackageName().equals(ai.packageName)) &#123;</span><br><span class="line">            c = context;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mInitialApplication != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                mInitialApplication.getPackageName().equals(ai.packageName)) &#123;</span><br><span class="line">            c = mInitialApplication;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            c = context.createPackageContext(ai.packageName,</span><br><span class="line">                    Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//无法获取context则直接返回</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> java.lang.ClassLoader cl = c.getClassLoader();</span><br><span class="line">            <span class="comment">//通过反射，创建目标ContentProvider对象</span></span><br><span class="line">            localProvider = (ContentProvider)cl.</span><br><span class="line">                loadClass(info.name).newInstance();</span><br><span class="line">            <span class="comment">//[见小节4.1]</span></span><br><span class="line">            provider = localProvider.getIContentProvider();</span><br><span class="line">            <span class="keyword">if</span> (provider == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//回调目标ContentProvider.onCreate方法</span></span><br><span class="line">            localProvider.attachInfo(c, info);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (java.lang.Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    IActivityManager.ContentProviderHolder retHolder;</span><br><span class="line">    synchronized (mProviderMap) &#123;</span><br><span class="line">        IBinder jBinder = provider.asBinder();</span><br><span class="line">        <span class="keyword">if</span> (localProvider != <span class="literal">null</span>) &#123;</span><br><span class="line">            ComponentName cname = new ComponentName(info.packageName, info.name);</span><br><span class="line">            ProviderClientRecord pr = mLocalProvidersByName.<span class="keyword">get</span>(cname);</span><br><span class="line">            <span class="keyword">if</span> (pr != <span class="literal">null</span>) &#123;</span><br><span class="line">                provider = pr.mProvider;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                holder = new IActivityManager.ContentProviderHolder(info);</span><br><span class="line">                holder.provider = provider;</span><br><span class="line">                holder.noReleaseNeeded = <span class="literal">true</span>;</span><br><span class="line">                pr = installProviderAuthoritiesLocked(provider, localProvider, holder);</span><br><span class="line">                mLocalProviders.put(jBinder, pr);</span><br><span class="line">                mLocalProvidersByName.put(cname, pr);</span><br><span class="line">            &#125;</span><br><span class="line">            retHolder = pr.mHolder;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> retHolder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该过程主要是通过反射，创建目标ContentProvider对象,并调用该对象onCreate方法.</p>
<h3 id="3-1-1-getIContentProvider"><a href="#3-1-1-getIContentProvider" class="headerlink" title="3.1.1 getIContentProvider()"></a><span id="jump2_4_1"/>3.1.1 getIContentProvider()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># ContentProvider.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ContentProvider</span> <span class="keyword">implements</span> <span class="title class_">ComponentCallbacks2</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Transport</span> <span class="variable">mTransport</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Transport</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Transport</span> <span class="keyword">extends</span> <span class="title class_">ContentProviderNative</span> &#123;</span><br><span class="line">        ContentProvider <span class="title function_">getContentProvider</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ContentProvider.<span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取Transport</span></span><br><span class="line">    <span class="keyword">public</span> IContentProvider <span class="title function_">getIContentProvider</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mTransport;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Transport继承于ContentProviderNative, 而ContentProviderNative实现接口IContentProvider.</p>
<h3 id="3-2-AMS-publishContentProviders"><a href="#3-2-AMS-publishContentProviders" class="headerlink" title="3.2 AMS.publishContentProviders()"></a><span id="jump2_5"/>3.2 AMS.publishContentProviders()</h3><p>由AMP.publishContentProviders经过binder IPC，交由AMS.publishContentProviders来处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">publishContentProviders</span><span class="params">(IApplicationThread caller, List&lt;ContentProviderHolder&gt; providers)</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (providers == <span class="literal">null</span>) &#123;</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">       <span class="keyword">final</span> <span class="type">ProcessRecord</span> <span class="variable">r</span> <span class="operator">=</span> getRecordForAppLocked(caller);</span><br><span class="line">       <span class="keyword">if</span> (r == <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(...);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> <span class="type">long</span> <span class="variable">origId</span> <span class="operator">=</span> Binder.clearCallingIdentity();</span><br><span class="line">       <span class="keyword">final</span> <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> providers.size();</span><br><span class="line">       <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">           <span class="type">ContentProviderHolder</span> <span class="variable">src</span> <span class="operator">=</span> providers.get(i);</span><br><span class="line">           <span class="keyword">if</span> (src == <span class="literal">null</span> || src.info == <span class="literal">null</span> || src.provider == <span class="literal">null</span>) &#123;</span><br><span class="line">               <span class="keyword">continue</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="type">ContentProviderRecord</span> <span class="variable">dst</span> <span class="operator">=</span> r.pubProviders.get(src.info.name);</span><br><span class="line">           <span class="keyword">if</span> (dst != <span class="literal">null</span>) &#123;</span><br><span class="line">               <span class="type">ComponentName</span> <span class="variable">comp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComponentName</span>(dst.info.packageName, dst.info.name);</span><br><span class="line">               <span class="comment">//将该provider添加到mProviderMap</span></span><br><span class="line">               mProviderMap.putProviderByClass(comp, dst);</span><br><span class="line">               String names[] = dst.info.authority.split(<span class="string">&quot;;&quot;</span>);</span><br><span class="line">               <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; names.length; j++) &#123;</span><br><span class="line">                   mProviderMap.putProviderByName(names[j], dst);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="type">int</span> <span class="variable">launchingCount</span> <span class="operator">=</span> mLaunchingProviders.size();</span><br><span class="line">               <span class="type">int</span> j;</span><br><span class="line">               <span class="type">boolean</span> <span class="variable">wasInLaunchingProviders</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">               <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; launchingCount; j++) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (mLaunchingProviders.get(j) == dst) &#123;</span><br><span class="line">                       <span class="comment">//将该provider移除mLaunchingProviders队列</span></span><br><span class="line">                       mLaunchingProviders.remove(j);</span><br><span class="line">                       wasInLaunchingProviders = <span class="literal">true</span>;</span><br><span class="line">                       j--;</span><br><span class="line">                       launchingCount--;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (wasInLaunchingProviders) &#123;</span><br><span class="line">                   mHandler.removeMessages(CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG, r);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">synchronized</span> (dst) &#123;</span><br><span class="line">                   dst.provider = src.provider;</span><br><span class="line">                   dst.proc = r;</span><br><span class="line">                   <span class="comment">//唤醒客户端的wait等待方法</span></span><br><span class="line">                   dst.notifyAll();</span><br><span class="line">               &#125;</span><br><span class="line">               updateOomAdjLocked(r);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       Binder.restoreCallingIdentity(origId);</span><br><span class="line">   &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一旦publish成功,则会移除provider发布超时的消息,并且调用notifyAll()来唤醒所有等待的Client端进程。</p>
<h1 id="三、ContentProvider查询原理"><a href="#三、ContentProvider查询原理" class="headerlink" title="三、ContentProvider查询原理"></a><span id="jump3"/>三、ContentProvider查询原理</h1><h2 id="（1）完整查询过程"><a href="#（1）完整查询过程" class="headerlink" title="（1）完整查询过程"></a><span id="jump3_1"/>（1）完整查询过程</h2><p>在查询时是多进程通讯的过程，<br>例如APP1访问 &#x3D;&gt; APP2的ContentProvider</p>
<ul>
<li>（1）App1：<ul>
<li>1、ContentResolover.query()</li>
<li>2、ActivityThread.acquireProvier()</li>
<li>3、通过AMP.getContentProvider() 从AMS中获取ContentProvider；</li>
</ul>
</li>
<li>（2）AMS：<ul>
<li>1、AMS.getContentProviderImpl()</li>
<li>2、AMS.startProcessLocked() 【若App2进程未启动，就通过这个启动】</li>
<li>3、cpr.wait() 挂起等待App2进程启动后，ContentProvider注册后唤起</li>
</ul>
</li>
<li>（3）App2：<ul>
<li>1、启动App，</li>
<li>2、publishContentProvider()将ContentProvider注册到AMS中【若App2未启动，走这个1&#x2F;2两步】</li>
<li>2、AMP.notify()唤起AMS的等待的线程；</li>
</ul>
</li>
<li>（2）AMS：<ul>
<li>1、notify() 唤起等待的线程</li>
<li>2、回调App1.installProvider()方法</li>
</ul>
</li>
<li>（1）APP1：<ul>
<li>1、执行installProvider操作，安装provider的(包含对象记录,引用计数维护等工作)；<ul>
<li><blockquote>
<p>注意这个installProvider是用来获取ContentProviderProxy的等操作的</p>
</blockquote>
</li>
</ul>
</li>
<li>2、ContentProviderNative.query()就可以通过binder和ContentProvider跨进程通信查询数据了；</li>
</ul>
</li>
</ul>
<p>简图如下：<br><img src="https://raw.githubusercontent.com/IRVING18/pic/master/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-ContentProvider%E5%90%AF%E5%8A%A8_6.jpg" alt="image.png"></p>
<p>时序图如下：</p>
<blockquote>
<p>这些关键方法名可以稍微记一下；</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/IRVING18/pic/master/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-ContentProvider%E5%90%AF%E5%8A%A8_7.jpg" alt="image.png"></p>
<h2 id="（2）服务端：发布ContentProvider"><a href="#（2）服务端：发布ContentProvider" class="headerlink" title="（2）服务端：发布ContentProvider"></a><span id="jump3_2"/>（2）服务端：发布ContentProvider</h2><p>在上边<a href="#jump2">二、ContentProvider启动</a>已经讲过了，<br>这里贴一下的意思是，注意如果App1去获取App2的ContentProvider的话，如果App2还没启动，就会在AMS中</p>
<ul>
<li>1、先启动App2，然后等待wait()</li>
<li>2、APP2启动后，publishContentProvider到AMS后，在notify唤起</li>
<li>3、继续走到App1的.installProvider()中去</li>
</ul>
<h2 id="（3）客户端：ActivityThread-installProvider-获取ContentProviderProxy"><a href="#（3）客户端：ActivityThread-installProvider-获取ContentProviderProxy" class="headerlink" title="（3）客户端：ActivityThread.installProvider()获取ContentProviderProxy"></a><span id="jump3_3"/>（3）客户端：ActivityThread.installProvider()获取ContentProviderProxy</h2><p>注意：</p>
<ul>
<li>1、此时的installProvider()会走到另一个if中去，不是那个初始化自己ContentProvider的if；</li>
<li>2、这个if中，会去获取远程的App2的ContentProvider的binder对象，ContentProviderProxy；</li>
</ul>
<p>还有一些引用计数的操作，感觉不太重要了，想看详细的直接看gityuan的文章吧<br><a target="_blank" rel="noopener" href="https://gityuan.com/2016/07/30/content-provider/">https://gityuan.com/2016/07/30/content-provider/</a></p>
<h2 id="（4）客户端：与ContentProviderNative进行binder通信query-查询数据"><a href="#（4）客户端：与ContentProviderNative进行binder通信query-查询数据" class="headerlink" title="（4）客户端：与ContentProviderNative进行binder通信query()查询数据"></a><span id="jump3_4"/>（4）客户端：与ContentProviderNative进行binder通信query()查询数据</h2><p>到这步，就获取到ContentProvider的binder对象了；<br>就可以通过binder机制和ContentProviderNative通信查询数据了；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"> # ContentProviderNative.java ::ContentProviderProxy</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">public</span> Cursor <span class="title function_">query</span><span class="params">(String callingPkg, Uri url, String[] projection, String selection, String[] selectionArgs, String sortOrder, ICancellationSignal cancellationSignal)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    <span class="comment">//实例化BulkCursorToCursorAdaptor对象</span></span><br><span class="line">    <span class="type">BulkCursorToCursorAdaptor</span> <span class="variable">adaptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BulkCursorToCursorAdaptor</span>();</span><br><span class="line">    <span class="type">Parcel</span> <span class="variable">data</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">    <span class="type">Parcel</span> <span class="variable">reply</span> <span class="operator">=</span> Parcel.obtain();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        data.writeInterfaceToken(IContentProvider.descriptor);</span><br><span class="line">        data.writeString(callingPkg);</span><br><span class="line">        url.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (projection != <span class="literal">null</span>) &#123;</span><br><span class="line">            length = projection.length;</span><br><span class="line">        &#125;</span><br><span class="line">        data.writeInt(length);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            data.writeString(projection[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        data.writeString(selection);</span><br><span class="line">        <span class="keyword">if</span> (selectionArgs != <span class="literal">null</span>) &#123;</span><br><span class="line">            length = selectionArgs.length;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            length = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        data.writeInt(length);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            data.writeString(selectionArgs[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        data.writeString(sortOrder);</span><br><span class="line">        data.writeStrongBinder(adaptor.getObserver().asBinder());</span><br><span class="line">        data.writeStrongBinder(cancellationSignal != <span class="literal">null</span> ? cancellationSignal.asBinder() : <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//发送给Binder服务端【见小节2.10】</span></span><br><span class="line">        mRemote.transact(IContentProvider.QUERY_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        DatabaseUtils.readExceptionFromParcel(reply);</span><br><span class="line">        <span class="keyword">if</span> (reply.readInt() != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">BulkCursorDescriptor</span> <span class="variable">d</span> <span class="operator">=</span> BulkCursorDescriptor.CREATOR.createFromParcel(reply);</span><br><span class="line">            adaptor.initialize(d);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            adaptor.close();</span><br><span class="line">            adaptor = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> adaptor;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">        adaptor.close();</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">        adaptor.close();</span><br><span class="line">        <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        data.recycle();</span><br><span class="line">        reply.recycle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="四、ContentProvider服务端两种情况的区分"><a href="#四、ContentProvider服务端两种情况的区分" class="headerlink" title="四、ContentProvider服务端两种情况的区分"></a><span id="jump4"/>四、ContentProvider服务端两种情况的区分</h1><h2 id="（1）服务端未启动"><a href="#（1）服务端未启动" class="headerlink" title="（1）服务端未启动"></a><span id="jump4_1"/>（1）服务端未启动</h2><p>Provider进程不存在: 当provider进程不存在时,先创建进程并publish相关的provider:</p>
<p><img src="https://raw.githubusercontent.com/IRVING18/pic/master/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-ContentProvider%E5%90%AF%E5%8A%A8_8.jpg" alt="image.png"></p>
<ol>
<li>client进程：通过binder(调用AMS.getContentProviderImpl)向system_server进程请求相应的provider；</li>
<li>system进程：如果目标provider所对应的进程尚未启动，system_server会调用startProcessLocked来启动provider进程； 当进程启动完成，此时cpr.provider &#x3D;&#x3D;null，则system_server便会进入wait()状态，等待目标provider发布；</li>
<li>provider进程：进程启动后执行完attch到system_server，紧接着执行bindApplication；在这个过程会installProvider以及 publishContentProviders；再binder call到system_server进程；</li>
<li>system进程：再回到system_server，发布provider信息，并且通过notify机制，唤醒前面处于wait状态的binder线程；并将 getContentProvider的结果返回给client进程；</li>
<li>client进程：接着执行installProvider操作，安装provider的(包含对象记录,引用计数维护等工作)；</li>
</ol>
<p>另外，关于CONTENT_PROVIDER_PUBLISH_TIMEOUT超时机制所统计的时机区间是指在startProcessLocked之后会调用AMS.attachApplicationLocked为起点，一直到AMS.publishContentProviders的过程。</p>
<h2 id="（2）服务端已启动"><a href="#（2）服务端已启动" class="headerlink" title="（2）服务端已启动"></a><span id="jump4_2"/>（2）服务端已启动</h2><p>provider未发布: 请求provider时,provider进程存在但provide的记录对象cpr &#x3D;&#x3D;null,这时的流程如下:</p>
<p><img src="https://raw.githubusercontent.com/IRVING18/pic/master/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-ContentProvider%E5%90%AF%E5%8A%A8_9.jpg" alt="image.png"></p>
<ul>
<li>Client进程在获取provider的过程,发现cpr为空,则调用scheduleInstallProvider来向provider所在进程发出一个oneway的binder请求,并进入wait()状态.</li>
<li>provider进程安装完provider信息,则notifyAll()处于等待状态的进程&#x2F;线程;</li>
</ul>
<p>如果provider在publish完成之后, 这时再次请求该provider,那就便没有的最右侧的这个过程,直接在AMS.getContentProviderImpl之后便进入AT.installProvider的过程,而不会再次进入wait()过程.</p>
<h1 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a><span id="jump5"/>五、总结</h1><h2 id="（1）ContentProvider交互原理"><a href="#（1）ContentProvider交互原理" class="headerlink" title="（1）ContentProvider交互原理"></a>（1）ContentProvider交互原理</h2><ul>
<li>1、服务端APP启动时将自己的ContentProvider注册到AMS的map中</li>
<li>2、客户端通过AMS获取ContentProvider的binder对象，ContentProviderProxy</li>
<li>3、客户端通过CPP和CPN进行交互</li>
</ul>
<h2 id="（2）AMS在ContentProvider注册好，notify线程时调用客户端App的installProvider"><a href="#（2）AMS在ContentProvider注册好，notify线程时调用客户端App的installProvider" class="headerlink" title="（2）AMS在ContentProvider注册好，notify线程时调用客户端App的installProvider()"></a>（2）AMS在ContentProvider注册好，notify线程时调用客户端App的installProvider()</h2><ul>
<li>主要目的就是获取让客户端app去通过计数获取ContentProviderProxy对象</li>
<li>然后通过CPP和ContentProviderNative通信</li>
</ul>
<p>关于provider分为stable provider和unstable provider, 在于引用计数 的不同？</p>
<ul>
<li>目的：一句话来说就是stable provider建立的是强连接, </li>
<li>客户端进程的与provider进程是存在依赖关系, </li>
<li>即provider进程死亡则会导致客户端进程被杀.</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://irving18.github.io">王征</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://irving18.github.io/2024/09/07/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-ContentProvider%E5%90%AF%E5%8A%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">https://irving18.github.io/2024/09/07/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-ContentProvider%E5%90%AF%E5%8A%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://irving18.github.io" target="_blank">Android高级直通车</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android%E8%BF%9B%E9%98%B6/">Android进阶</a><a class="post-meta__tags" href="/tags/Framework/">Framework</a><a class="post-meta__tags" href="/tags/%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6/">四大组件</a></div><div class="post-share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat_pay.png" target="_blank"><img class="post-qr-code-img" src="/img/wechat_pay.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2024/09/16/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-Service1%E4%BD%BF%E7%94%A8%E7%AF%87/" title="Framework四大组件篇-Service1使用篇"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Framework四大组件篇-Service1使用篇</div></div><div class="info-2"><div class="info-item-1">目录 一、start方式启动 （1）启动示例 （2）生命周期执行 （3）多次startService？start和stop关系？ （4）前台服务、后台服务   二、bind方式启动 （1）启动示例 （2）生命周期执行 （3）Connection和Service的关系？ （4）多次bindService？多次unBindService？ （5）bindService的第三个入参枚举含义   三、如何正确的关闭Service （1）start方式 （2）bind方式 （3）start + bind方式   四、start&#x2F;bind对应的使用场景 （1）start （2）bind （3）start + bind...</div></div></div></a><a class="pagination-related" href="/2024/08/30/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-BroadCast%E5%8E%9F%E7%90%86%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="Framework四大组件篇-BroadCast原理源码分析"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Framework四大组件篇-BroadCast原理源码分析</div></div><div class="info-2"><div class="info-item-1"> AMS：http://aospxref.com/android-6.0.1_r9/xref/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.javaAMN&#x2F;AMP：http://aospxref.com/android-6.0.1_r9/xref/frameworks/base/core/java/android/app/ActivityManagerNative.java  目录 一、总结先行 （1）广播处理机制？ （2）ANR：无序广播、有序广播？ （3）ANR时间：前台、后台？ （4）ANR：静态注册会有ANR吗？ （5）静态注册拉起进程？Android...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2024/08/27/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-BroadCast%E4%BD%BF%E7%94%A8/" title="Framework四大组件篇-BroadCast使用"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-27</div><div class="info-item-2">Framework四大组件篇-BroadCast使用</div></div><div class="info-2"><div class="info-item-1">目录 一、广播接收 （1）静态注册 （2）动态注册 （3）接收优先级 （4）前台广播、后台广播   二、广播发送 （1）无序广播 （2）有序广播 给下游传输数据、中断广播   （3）粘性广播（异步广播） （4）粘性有序广播 （5）前台广播、后台广播   三、常用系统广播汇总 （1）开机广播 （2）网络状态广播 （3）电量变化   四、Interview常见问题 （1）广播的超时时间 （2）广播中想做耗时操作，应该怎么搞？    一、广播接收定义一个默认广播，用于接收广播消息； 12345678910111213class MyBroadCast : BroadcastReceiver() &#123;    companion object &#123;        val WZ_RECEIVER = &quot;com.wz.test.MyTestBroadCast&quot;    &#125;    override fun onReceive(context: Context, intent: Intent) &#123;       ...</div></div></div></a><a class="pagination-related" href="/2024/08/30/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-BroadCast%E5%8E%9F%E7%90%86%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="Framework四大组件篇-BroadCast原理源码分析"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-30</div><div class="info-item-2">Framework四大组件篇-BroadCast原理源码分析</div></div><div class="info-2"><div class="info-item-1"> AMS：http://aospxref.com/android-6.0.1_r9/xref/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.javaAMN&#x2F;AMP：http://aospxref.com/android-6.0.1_r9/xref/frameworks/base/core/java/android/app/ActivityManagerNative.java  目录 一、总结先行 （1）广播处理机制？ （2）ANR：无序广播、有序广播？ （3）ANR时间：前台、后台？ （4）ANR：静态注册会有ANR吗？ （5）静态注册拉起进程？Android...</div></div></div></a><a class="pagination-related" href="/2024/09/16/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-Service1%E4%BD%BF%E7%94%A8%E7%AF%87/" title="Framework四大组件篇-Service1使用篇"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-16</div><div class="info-item-2">Framework四大组件篇-Service1使用篇</div></div><div class="info-2"><div class="info-item-1">目录 一、start方式启动 （1）启动示例 （2）生命周期执行 （3）多次startService？start和stop关系？ （4）前台服务、后台服务   二、bind方式启动 （1）启动示例 （2）生命周期执行 （3）Connection和Service的关系？ （4）多次bindService？多次unBindService？ （5）bindService的第三个入参枚举含义   三、如何正确的关闭Service （1）start方式 （2）bind方式 （3）start + bind方式   四、start&#x2F;bind对应的使用场景 （1）start （2）bind （3）start + bind...</div></div></div></a><a class="pagination-related" href="/2024/09/17/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-Service%EF%BC%9AbindService%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="Framework四大组件篇-Service：bindService源码分析"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-17</div><div class="info-item-2">Framework四大组件篇-Service：bindService源码分析</div></div><div class="info-2"><div class="info-item-1">目录 总结先行 导读 （1）bindService的核心方法 （2）核心AMS启动流程   一、启动方App （1）ContentImpl.bindService()启动 （2）getServiceDispatcher()获取本地BnBinder对象 2.1、根据ServiceConnection创建ServiceDispatcher，并创建BnBinder服务端 2.2、map存储：ServiceConnection -&gt; ServiceDispatcher 键值对   （3）AMP.bindService(sd)将BnBinder传给AMS   二、system_service进程：AMS端 （4）AMN.onTransact()接收启动方的BnBinder对象，并持有 （5）AMS.bindService()   三、system_service进程：ActiveService端 （6）AS.bringUpServiceLocked() 6.1...</div></div></div></a><a class="pagination-related" href="/2024/09/20/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-Service%EF%BC%9AstartService%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="Framework四大组件篇-Service：startService源码分析"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-20</div><div class="info-item-2">Framework四大组件篇-Service：startService源码分析</div></div><div class="info-2"><div class="info-item-1">目录 一、总结先行 导读 （1）startService的核心方法 （2）核心AMS启动流程   二、Service进程启动流程 三、startService调用流程 （0）完整时序图 （1）启动方App：startService 1、ContentImpl.startServiceCommon() 2、ActivityManager.getService()获取AMS的BpBinder 3、AMP.startService调用至AMS   （2）system_service进程端：AMS调度启动Service 1、AMN.onTransact() 接收AMP发送的数据 2、AMS.startService() 启动Service   （3）sysytem_service进程端：ActiveService启动Service 1、AS.startServiceLocked() 2、AS.bringUpServiceLocked() 2.1 进程未启动时，AMS.attachApplicationLocked启动进程   3、进程已启动...</div></div></div></a><a class="pagination-related" href="/2024/03/07/ANR%E6%9C%BA%E5%88%B6%E5%8E%9F%E7%90%86%E3%80%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" title="ANR机制原理、解决方案"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-07</div><div class="info-item-2">ANR机制原理、解决方案</div></div><div class="info-2"><div class="info-item-1">...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">王征</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">41</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/IRVING18"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:ivring18@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"><span>Android开发者迈向<span style="color:red; weight:bold" >高级Android开发</span>的直通车，总结了各大面试考点！<span></br><span>一个通人性的博主，码字不易，用爱发电。希望大家多多支持。</span><img width="250px" src="/img/wechat_pay.png"></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95"><span class="toc-number">1.</span> <span class="toc-text">目录</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81ContentProvider%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">一、ContentProvider基本使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E4%BB%8B%E7%BB%8D%E4%B8%8BContentProvider%E3%80%81ContentResolver%E3%80%81ContentObserver%E4%B8%89%E8%80%85%E5%85%B3%E7%B3%BB"><span class="toc-number">2.1.</span> <span class="toc-text">（1）介绍下ContentProvider、ContentResolver、ContentObserver三者关系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81ContentProvider-%E6%8E%A5%E5%8F%A3"><span class="toc-number">2.1.1.</span> <span class="toc-text">1、ContentProvider 接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81ContentResolver-%E6%8E%A5%E5%8F%A3"><span class="toc-number">2.1.2.</span> <span class="toc-text">2、ContentResolver 接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81ContentObserver-%E6%8E%A5%E5%8F%A3"><span class="toc-number">2.1.3.</span> <span class="toc-text">3、ContentObserver 接口</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E6%9C%8D%E5%8A%A1%E7%AB%AFContentProvider"><span class="toc-number">2.2.</span> <span class="toc-text">（2）服务端ContentProvider</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%E7%B1%BB"><span class="toc-number">2.2.1.</span> <span class="toc-text">1、数据库操作类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89-ContentProvider"><span class="toc-number">2.2.2.</span> <span class="toc-text">2、自定义 ContentProvider</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81AndroidManifest%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.3.</span> <span class="toc-text">3、AndroidManifest配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E5%AE%A2%E6%88%B7%E7%AB%AFContentResolver"><span class="toc-number">2.3.</span> <span class="toc-text">（3）客户端ContentResolver</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="toc-number">2.3.1.</span> <span class="toc-text">1、实体类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89-ContentResolver"><span class="toc-number">2.3.2.</span> <span class="toc-text">2、自定义 ContentResolver</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E7%9B%91%E5%90%AC%E7%AB%AFContentObserver"><span class="toc-number">2.4.</span> <span class="toc-text">（4）监听端ContentObserver</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89-ContentObserver"><span class="toc-number">2.4.1.</span> <span class="toc-text">1、自定义 ContentObserver</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81ContentProvider%E5%90%AF%E5%8A%A8%E5%8E%9F%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">二、ContentProvider启动原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E8%A8%80"><span class="toc-number">3.1.</span> <span class="toc-text">引言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E5%AE%8C%E6%95%B4%E6%97%B6%E5%BA%8F%E5%9B%BE"><span class="toc-number">3.2.</span> <span class="toc-text">（1）完整时序图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%882%EF%BC%89ActivityThread-bindApplication"><span class="toc-number">3.3.</span> <span class="toc-text">（2）ActivityThread.bindApplication()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%883%EF%BC%89ActivityThread-installContentProviders"><span class="toc-number">3.4.</span> <span class="toc-text">（3）ActivityThread.installContentProviders()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-ActivityThread-installProvider"><span class="toc-number">3.4.1.</span> <span class="toc-text">3.1 ActivityThread.installProvider()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-1-getIContentProvider"><span class="toc-number">3.4.2.</span> <span class="toc-text">3.1.1 getIContentProvider()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-AMS-publishContentProviders"><span class="toc-number">3.4.3.</span> <span class="toc-text">3.2 AMS.publishContentProviders()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81ContentProvider%E6%9F%A5%E8%AF%A2%E5%8E%9F%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">三、ContentProvider查询原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E5%AE%8C%E6%95%B4%E6%9F%A5%E8%AF%A2%E8%BF%87%E7%A8%8B"><span class="toc-number">4.1.</span> <span class="toc-text">（1）完整查询过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E6%9C%8D%E5%8A%A1%E7%AB%AF%EF%BC%9A%E5%8F%91%E5%B8%83ContentProvider"><span class="toc-number">4.2.</span> <span class="toc-text">（2）服务端：发布ContentProvider</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%9AActivityThread-installProvider-%E8%8E%B7%E5%8F%96ContentProviderProxy"><span class="toc-number">4.3.</span> <span class="toc-text">（3）客户端：ActivityThread.installProvider()获取ContentProviderProxy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%9A%E4%B8%8EContentProviderNative%E8%BF%9B%E8%A1%8Cbinder%E9%80%9A%E4%BF%A1query-%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE"><span class="toc-number">4.4.</span> <span class="toc-text">（4）客户端：与ContentProviderNative进行binder通信query()查询数据</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81ContentProvider%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%B8%A4%E7%A7%8D%E6%83%85%E5%86%B5%E7%9A%84%E5%8C%BA%E5%88%86"><span class="toc-number">5.</span> <span class="toc-text">四、ContentProvider服务端两种情况的区分</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%9C%AA%E5%90%AF%E5%8A%A8"><span class="toc-number">5.1.</span> <span class="toc-text">（1）服务端未启动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%B7%B2%E5%90%AF%E5%8A%A8"><span class="toc-number">5.2.</span> <span class="toc-text">（2）服务端已启动</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">五、总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%881%EF%BC%89ContentProvider%E4%BA%A4%E4%BA%92%E5%8E%9F%E7%90%86"><span class="toc-number">6.1.</span> <span class="toc-text">（1）ContentProvider交互原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%882%EF%BC%89AMS%E5%9C%A8ContentProvider%E6%B3%A8%E5%86%8C%E5%A5%BD%EF%BC%8Cnotify%E7%BA%BF%E7%A8%8B%E6%97%B6%E8%B0%83%E7%94%A8%E5%AE%A2%E6%88%B7%E7%AB%AFApp%E7%9A%84installProvider"><span class="toc-number">6.2.</span> <span class="toc-text">（2）AMS在ContentProvider注册好，notify线程时调用客户端App的installProvider()</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/20/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-Service%EF%BC%9AstartService%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="Framework四大组件篇-Service：startService源码分析">Framework四大组件篇-Service：startService源码分析</a><time datetime="2024-09-20T07:40:47.000Z" title="发表于 2024-09-20 15:40:47">2024-09-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/17/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-Service%EF%BC%9AbindService%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="Framework四大组件篇-Service：bindService源码分析">Framework四大组件篇-Service：bindService源码分析</a><time datetime="2024-09-17T07:40:36.000Z" title="发表于 2024-09-17 15:40:36">2024-09-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/16/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-Service1%E4%BD%BF%E7%94%A8%E7%AF%87/" title="Framework四大组件篇-Service1使用篇">Framework四大组件篇-Service1使用篇</a><time datetime="2024-09-16T07:40:35.000Z" title="发表于 2024-09-16 15:40:35">2024-09-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/07/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-ContentProvider%E5%90%AF%E5%8A%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="Framework四大组件篇-ContentProvider启动源码分析">Framework四大组件篇-ContentProvider启动源码分析</a><time datetime="2024-09-07T07:39:36.000Z" title="发表于 2024-09-07 15:39:36">2024-09-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/30/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-BroadCast%E5%8E%9F%E7%90%86%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="Framework四大组件篇-BroadCast原理源码分析">Framework四大组件篇-BroadCast原理源码分析</a><time datetime="2024-08-30T07:40:05.000Z" title="发表于 2024-08-30 15:40:05">2024-08-30</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/bg.png);"><div id="footer-wrap"><div class="copyright">&copy;2024 By 王征</div><div class="footer_custom_text"><a href=""><img class="icp-icon" src="/img/avatar.jpg"><span>一个通人性的博主</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>