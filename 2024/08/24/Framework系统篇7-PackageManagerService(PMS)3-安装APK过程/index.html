<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Framework系统篇7-PackageManagerService(PMS)3-安装APK过程 | Android高级直通车</title><meta name="author" content="王征"><meta name="copyright" content="王征"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="目录 一、PackageHandler处理安装消息 1.1 PMS.installStage() 1.2 PackageHandler处理INIT_COPY消息 1.2.1 connectToService()启动DefaultContainerService服务（用于检查和复制可移动文件的服务） 1.2.2 绑定服务后，继续发送MCS_BOUND消息，处理安装   1.3 PackageHand">
<meta property="og:type" content="article">
<meta property="og:title" content="Framework系统篇7-PackageManagerService(PMS)3-安装APK过程">
<meta property="og:url" content="https://irving18.github.io/2024/08/24/Framework%E7%B3%BB%E7%BB%9F%E7%AF%877-PackageManagerService(PMS)3-%E5%AE%89%E8%A3%85APK%E8%BF%87%E7%A8%8B/index.html">
<meta property="og:site_name" content="Android高级直通车">
<meta property="og:description" content="目录 一、PackageHandler处理安装消息 1.1 PMS.installStage() 1.2 PackageHandler处理INIT_COPY消息 1.2.1 connectToService()启动DefaultContainerService服务（用于检查和复制可移动文件的服务） 1.2.2 绑定服务后，继续发送MCS_BOUND消息，处理安装   1.3 PackageHand">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://irving18.github.io/img/avatar.jpg">
<meta property="article:published_time" content="2024-08-24T07:38:31.000Z">
<meta property="article:modified_time" content="2024-12-27T09:05:34.442Z">
<meta property="article:author" content="王征">
<meta property="article:tag" content="Android进阶">
<meta property="article:tag" content="Framework">
<meta property="article:tag" content="系统服务">
<meta property="article:tag" content="PMS">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://irving18.github.io/img/avatar.jpg"><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="canonical" href="https://irving18.github.io/2024/08/24/Framework%E7%B3%BB%E7%BB%9F%E7%AF%877-PackageManagerService(PMS)3-%E5%AE%89%E8%A3%85APK%E8%BF%87%E7%A8%8B/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Framework系统篇7-PackageManagerService(PMS)3-安装APK过程',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">41</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/bg.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Android高级直通车</span></a><a class="nav-page-title" href="/"><span class="site-name">Framework系统篇7-PackageManagerService(PMS)3-安装APK过程</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Framework系统篇7-PackageManagerService(PMS)3-安装APK过程</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-08-24T07:38:31.000Z" title="发表于 2024-08-24 15:38:31">2024-08-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-12-27T09:05:34.442Z" title="更新于 2024-12-27 17:05:34">2024-12-27</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android%E8%BF%9B%E9%98%B6/">Android进阶</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">3.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>13分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><ul>
<li><a href="#jump1">一、PackageHandler处理安装消息</a><ul>
<li><a href="#jump1_1">1.1 PMS.installStage()</a></li>
<li><a href="#jump1_2">1.2 PackageHandler处理INIT_COPY消息</a><ul>
<li><a href="#jump1_2_1">1.2.1 connectToService()启动DefaultContainerService服务（用于检查和复制可移动文件的服务）</a></li>
<li><a href="#jump1_2_2">1.2.2 绑定服务后，继续发送MCS_BOUND消息，处理安装</a></li>
</ul>
</li>
<li><a href="#jump1_3">1.3 PackageHandler处理MCS_BOUND消息</a><ul>
<li><a href="#jump1_3_1">1.3.1 安装尝试次数&gt;4次，就放弃安装</a></li>
<li><a href="#jump1_3_2">1.3.2 handleStartCopy()，开始复制流程</a></li>
<li><a href="#jump1_3_3">1.3.3 handleReturnCode()，开始安装流程</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#jump2">二、handleStartCopy()复制APK</a><ul>
<li><a href="#jump2_1">2.1 PMS.handleStartCopy()复制APK</a></li>
<li><a href="#jump2_2">2.2 FileInstallArgs.copyApk(mContainerService)发送至mContainerService服务</a></li>
<li><a href="#jump2_3">2.3 IMediaContainerService跨进程调用DefaultContainerService的copyPackage方法</a></li>
</ul>
</li>
<li><a href="#jump3">三、handleReturnCode()安装APK</a><ul>
<li><a href="#jump3_1">3.1 PMS.handleReturnCode()</a></li>
<li><a href="#jump3_2">3.2 PMS.processPendingInstall()</a></li>
<li><a href="#jump3_3">3.3 PMS.installPackageLI()解析apk安装</a></li>
<li><a href="#jump3_4">3.4 installNewPackageLIF()解析新app的四大组件等信息</a></li>
</ul>
</li>
<li><a href="#jump4">四、adb、界面安装APK的区别</a><ul>
<li><a href="#jump4_1">4.1 通过intent调起App安装</a></li>
<li><a href="#jump4_2">4.2 跳转到InstallStart的Activity中，根据入参是否为uri，进行Android版本区分处理</a></li>
<li><a href="#jump4_3">4.3 PackageInstallerActivity真实安装的页面</a><ul>
<li><a href="#jump4_3_1">4.3.1 判断是否能弹出安装页面，不能展示可以展示弹框或者跳设置页</a></li>
<li><a href="#jump4_3_2">4.3.2 initiateInstall() 初始化安装页面</a></li>
<li><a href="#jump4_3_3">4.3.3 onClick()用户点击同意安装，跳转至InstallInstalling的Activity中处理</a></li>
</ul>
</li>
<li><a href="#jump4_4">4.4 InstallInstalling的Activity通过PackageInstallerSession和PMS通信</a></li>
<li><a href="#jump4_5">4.5 调用至PMS服务中.installStage()中</a></li>
</ul>
</li>
<li><a href="#jump5">五、总结</a><ul>
<li><a href="#jump5_1">（1）安装过程完整流程图</a></li>
<li><a href="#jump5_2">（2）页面安装的核心Activity</a></li>
</ul>
</li>
<li><a href="#jump">参考文档</a></li>
</ul>
<p><img src="https://raw.githubusercontent.com/IRVING18/pic/master/Framework%E7%B3%BB%E7%BB%9F%E7%AF%877-PackageManagerService(PMS)3-%E5%AE%89%E8%A3%85APK%E8%BF%87%E7%A8%8B_1.jpg" alt="PMS安装过程.png"></p>
<h1 id="一、PackageHandler处理安装消息"><a href="#一、PackageHandler处理安装消息" class="headerlink" title="一、PackageHandler处理安装消息"></a><span id="jump1"/>一、PackageHandler处理安装消息</h1><p>无论是adb还是界面安装apk，最终都是PackageHandler来处理安装；</p>
<h2 id="1-1-PMS-installStage"><a href="#1-1-PMS-installStage" class="headerlink" title="1.1 PMS.installStage()"></a><span id="jump1_1"/>1.1 PMS.installStage()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">installStage</span><span class="params">(...)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">VerificationParams</span> <span class="variable">verifParams</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">VerificationParams</span>(<span class="literal">null</span>, params.originatingUri,</span><br><span class="line">            params.referrerUri, installerUid, <span class="literal">null</span>);</span><br><span class="line">    verifParams.setInstallerUid(installerUid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Message</span> <span class="variable">msg</span> <span class="operator">=</span> mHandler.obtainMessage(INIT_COPY);</span><br><span class="line">    msg.obj = <span class="keyword">new</span> <span class="title class_">InstallParams</span>(origin, <span class="literal">null</span>, observer, params.installFlags,..);</span><br><span class="line">    mHandler.sendMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-2-PackageHandler处理INIT-COPY消息"><a href="#1-2-PackageHandler处理INIT-COPY消息" class="headerlink" title="1.2 PackageHandler处理INIT_COPY消息"></a><span id="jump1_2"/>1.2 PackageHandler处理INIT_COPY消息</h2><p>主要工作：</p>
<ul>
<li>1、如果没有DefaultContainerService服务，先绑定</li>
<li>2、继续发送MCS_BOUND消息，处理安装</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PackageHandler</span> <span class="keyword">extends</span> <span class="title class_">Handler</span> &#123; </span><br><span class="line">    <span class="comment">//handler处理message</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            doHandleMessage(msg);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">doHandleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> INIT_COPY: &#123;</span><br><span class="line">                <span class="type">HandlerParams</span> <span class="variable">params</span> <span class="operator">=</span> (HandlerParams) msg.obj;</span><br><span class="line">                <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> mPendingInstalls.size();</span><br><span class="line">                <span class="comment">//判断是否绑定了服务，</span></span><br><span class="line">                <span class="keyword">if</span> (!mBound) &#123;</span><br><span class="line">                    <span class="comment">//1、如果没有绑定服务，重新绑定，connectToService方法内部如果绑定成功会将mBound置为true</span></span><br><span class="line">                    <span class="keyword">if</span> (!connectToService()) &#123;</span><br><span class="line">                        params.serviceError();</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mPendingInstalls.add(idx, params);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//2、已绑定服务，将继续发送MCS_BOUND消息</span></span><br><span class="line">                    mPendingInstalls.add(idx, params);</span><br><span class="line">                    <span class="keyword">if</span> (idx == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">//继续处理安装</span></span><br><span class="line">                        mHandler.sendEmptyMessage(MCS_BOUND);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-1-connectToService-启动DefaultContainerService服务（用于检查和复制可移动文件的服务）"><a href="#1-2-1-connectToService-启动DefaultContainerService服务（用于检查和复制可移动文件的服务）" class="headerlink" title="1.2.1 connectToService()启动DefaultContainerService服务（用于检查和复制可移动文件的服务）"></a><span id="jump1_2_1"/>1.2.1 connectToService()启动DefaultContainerService服务（用于检查和复制可移动文件的服务）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ComponentName</span> <span class="variable">DEFAULT_CONTAINER_COMPONENT</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComponentName</span>(</span><br><span class="line">        DEFAULT_CONTAINER_PACKAGE,</span><br><span class="line">        <span class="string">&quot;com.android.defcontainer.DefaultContainerService&quot;</span>);</span><br><span class="line">        </span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">connectToService</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//启动Service服务</span></span><br><span class="line">    <span class="type">Intent</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>().setComponent(DEFAULT_CONTAINER_COMPONENT);</span><br><span class="line">    <span class="comment">//绑定服务</span></span><br><span class="line">    <span class="keyword">if</span> (mContext.bindServiceAsUser(service, mDefContainerConn, Context.BIND_AUTO_CREATE, UserHandle.OWNER)) &#123;</span><br><span class="line">        mBound = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DefaultContainerService是用于检查和复制可移动文件的服务，</p>
<ul>
<li>这是一个比较耗时的操作，因此DefaultContainerService没有和PMS运行在同一进程中，</li>
<li>它运行在com.android.defcontainer进程，通过IMediaContainerService和PMS进行IPC通信，</li>
</ul>
<p>如下图所示。<br><img src="https://raw.githubusercontent.com/IRVING18/pic/master/Framework%E7%B3%BB%E7%BB%9F%E7%AF%877-PackageManagerService(PMS)3-%E5%AE%89%E8%A3%85APK%E8%BF%87%E7%A8%8B_2.jpg" alt="image.png"></p>
<h3 id="1-2-2-绑定服务后，继续发送MCS-BOUND消息，处理安装"><a href="#1-2-2-绑定服务后，继续发送MCS-BOUND消息，处理安装" class="headerlink" title="1.2.2 绑定服务后，继续发送MCS_BOUND消息，处理安装"></a><span id="jump1_2_2"/>1.2.2 绑定服务后，继续发送MCS_BOUND消息，处理安装</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mHandler.sendEmptyMessage(MCS_BOUND);</span><br></pre></td></tr></table></figure>


<h2 id="1-3-PackageHandler处理MCS-BOUND消息"><a href="#1-3-PackageHandler处理MCS-BOUND消息" class="headerlink" title="1.3 PackageHandler处理MCS_BOUND消息"></a><span id="jump1_3"/>1.3 PackageHandler处理MCS_BOUND消息</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">doHandleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> INIT_COPY: &#123;...&#125;</span><br><span class="line">        <span class="keyword">case</span> MCS_BOUND: &#123;</span><br><span class="line">            <span class="comment">//1、获取上边启动的服务</span></span><br><span class="line">            <span class="keyword">if</span> (msg.obj != <span class="literal">null</span>) &#123;</span><br><span class="line">                mContainerService = (IMediaContainerService) msg.obj;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mContainerService == <span class="literal">null</span>) &#123;</span><br><span class="line">                ...</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPendingInstalls.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">HandlerParams</span> <span class="variable">params</span> <span class="operator">=</span> mPendingInstalls.get(<span class="number">0</span>);</span><br><span class="line">                <span class="comment">//2、开始复制apk流程</span></span><br><span class="line">                <span class="keyword">if</span> (params.startCopy()) &#123;...&#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;&#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-3-1-安装尝试次数-4次，就放弃安装"><a href="#1-3-1-安装尝试次数-4次，就放弃安装" class="headerlink" title="1.3.1 安装尝试次数&gt;4次，就放弃安装"></a><span id="jump1_3_1"/>1.3.1 安装尝试次数&gt;4次，就放弃安装</h3><h3 id="1-3-2-handleStartCopy-，开始复制流程"><a href="#1-3-2-handleStartCopy-，开始复制流程" class="headerlink" title="1.3.2 handleStartCopy()，开始复制流程"></a><span id="jump1_3_2"/>1.3.2 handleStartCopy()，开始复制流程</h3><h3 id="1-3-3-handleReturnCode-，开始安装流程"><a href="#1-3-3-handleReturnCode-，开始安装流程" class="headerlink" title="1.3.3 handleReturnCode()，开始安装流程"></a><span id="jump1_3_3"/>1.3.3 handleReturnCode()，开始安装流程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">HandlerParams</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">startCopy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> res;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1、startCopy方法尝试的次数，超过了4次，就放弃这个安装请求</span></span><br><span class="line">            <span class="keyword">if</span> (++mRetries &gt; MAX_RETRIES) &#123;</span><br><span class="line">                mHandler.sendEmptyMessage(MCS_GIVE_UP);<span class="comment">//放弃安装</span></span><br><span class="line">                handleServiceError();</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//2、开始复制流程【见二】</span></span><br><span class="line">                handleStartCopy();</span><br><span class="line">                res = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3、开始安装流程【见三】</span></span><br><span class="line">        handleReturnCode();</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="二、复制apk"><a href="#二、复制apk" class="headerlink" title="二、复制apk"></a><span id="jump2"/>二、复制apk</h1><h2 id="2-1-PMS-handleStartCopy-复制APK"><a href="#2-1-PMS-handleStartCopy-复制APK" class="headerlink" title="2.1 PMS.handleStartCopy()复制APK"></a><span id="jump2_1"/>2.1 PMS.handleStartCopy()复制APK</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleStartCopy</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//确定APK的安装位置。onSd：安装到SD卡， onInt：内部存储即Data分区，ephemeral：安装到临时存储（Instant Apps安装）       final boolean onSd = (installFlags &amp; PackageManager.INSTALL_EXTERNAL) != 0;</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">onInt</span> <span class="operator">=</span> (installFlags &amp; PackageManager.INSTALL_INTERNAL) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">ephemeral</span> <span class="operator">=</span> (installFlags &amp; PackageManager.INSTALL_INSTANT_APP) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (onInt &amp;&amp; onSd) &#123;</span><br><span class="line">      <span class="comment">// APK不能同时安装在SD卡和Data分区</span></span><br><span class="line">        ret = PackageManager.INSTALL_FAILED_INVALID_INSTALL_LOCATION;</span><br><span class="line">      <span class="comment">//安装标志冲突，Instant Apps不能安装到SD卡中</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (onSd &amp;&amp; ephemeral) &#123;...&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据InstallParams创建InstallArgs对象</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">InstallArgs</span> <span class="variable">args</span> <span class="operator">=</span> createInstallArgs(<span class="built_in">this</span>);<span class="comment">//3</span></span><br><span class="line">    mArgs = args;</span><br><span class="line">    <span class="keyword">if</span> (ret == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">        ...</span><br><span class="line">        ret = args.copyApk(mContainerService, <span class="literal">true</span>);<span class="comment">//4</span></span><br><span class="line">    &#125;</span><br><span class="line">    mRet = ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-2-FileInstallArgs-copyApk-mContainerService-发送至mContainerService服务"><a href="#2-2-FileInstallArgs-copyApk-mContainerService-发送至mContainerService服务" class="headerlink" title="2.2 FileInstallArgs.copyApk(mContainerService)发送至mContainerService服务"></a><span id="jump2_2"/>2.2 FileInstallArgs.copyApk(mContainerService)发送至mContainerService服务</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FileInstallArgs</span> <span class="keyword">extends</span> <span class="title class_">InstallArgs</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">copyApk</span><span class="params">(IMediaContainerService imcs, <span class="type">boolean</span> temp)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="title function_">copyApk</span><span class="params">(IMediaContainerService imcs, <span class="type">boolean</span> temp)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">File</span> <span class="variable">tempDir</span> <span class="operator">=</span> mInstallerService.allocateStageDirLegacy(volumeUuid);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//复制apk文件</span></span><br><span class="line">            ret = imcs.copyPackage(origin.file.getAbsolutePath(), target);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>imcs是：</p>
<ul>
<li>IMediaContainerService跨进程调用DefaultContainerService的copyPackage方法，</li>
<li>这个方法会在DefaultContainerService所在的进程中将APK复制到临时存储目录，</li>
<li>比如&#x2F;data&#x2F;app&#x2F;vmdl18300388.tmp&#x2F;base.apk。目前为止APK的复制工作就完成了，接着就是APK的安装过程了。</li>
</ul>
<h2 id="2-3-IMediaContainerService跨进程调用DefaultContainerService的copyPackage方法"><a href="#2-3-IMediaContainerService跨进程调用DefaultContainerService的copyPackage方法" class="headerlink" title="2.3 IMediaContainerService跨进程调用DefaultContainerService的copyPackage方法"></a><span id="jump2_3"/>2.3 IMediaContainerService跨进程调用DefaultContainerService的copyPackage方法</h2><p>DefaultContainerService所在的进程中将APK复制到临时存储目录，</p>
<ul>
<li>比如&#x2F;data&#x2F;app&#x2F;vmdl18300388.tmp&#x2F;base.apk。</li>
<li>目前为止APK的复制工作就完成了，接着就是APK的安装过程了。</li>
</ul>
<h1 id="三、安装APK"><a href="#三、安装APK" class="headerlink" title="三、安装APK"></a><span id="jump3"/>三、安装APK</h1><h2 id="3-1-PMS-handleReturnCode"><a href="#3-1-PMS-handleReturnCode" class="headerlink" title="3.1 PMS.handleReturnCode()"></a><span id="jump3_1"/>3.1 PMS.handleReturnCode()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">handleReturnCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mArgs != <span class="literal">null</span>) &#123;</span><br><span class="line">        processPendingInstall(mArgs, mRet);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-2-PMS-processPendingInstall"><a href="#3-2-PMS-processPendingInstall" class="headerlink" title="3.2 PMS.processPendingInstall()"></a><span id="jump3_2"/>3.2 PMS.processPendingInstall()</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processPendingInstall</span><span class="params">(<span class="keyword">final</span> InstallArgs args, <span class="keyword">final</span> <span class="type">int</span> currentStatus)</span> &#123;</span><br><span class="line">    mHandler.post(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (res.returnCode == PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">                <span class="comment">//安装前处理</span></span><br><span class="line">                args.doPreInstall(res.returnCode);</span><br><span class="line">                <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                    <span class="comment">//安装</span></span><br><span class="line">                    installPackageLI(args, res);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//安装后收尾</span></span><br><span class="line">                args.doPostInstall(res.returnCode, res.uid);</span><br><span class="line">            &#125;</span><br><span class="line">          ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-3-PMS-installPackageLI-解析apk安装"><a href="#3-3-PMS-installPackageLI-解析apk安装" class="headerlink" title="3.3 PMS.installPackageLI()解析apk安装"></a><span id="jump3_3"/>3.3 PMS.installPackageLI()解析apk安装</h2><p>主要工作：</p>
<ul>
<li>1、解析APK</li>
<li>2、检查apk是否安装过，安装过直接获取一些信息</li>
<li>3、查看mSettings中是否有该apk的签名，并检验签名是否正确</li>
<li>4、处理权限信息</li>
<li>5、重命名临时文件<ul>
<li>比如前面提到的&#x2F;data&#x2F;app&#x2F;vmdl18300388.tmp&#x2F;base.apk，重命名为&#x2F;data&#x2F;app&#x2F;包名-1&#x2F;base.apk。这个新命名的包名会带上一个数字后缀1，每次升级一个已有的App，这个数字会不断的累加。</li>
</ul>
</li>
<li>6、安装：区分覆盖安装or新安装</li>
<li>7、更新应用程序所属的用户<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">installPackageLI</span><span class="params">(InstallArgs args, PackageInstalledInfo res)</span> &#123;</span><br><span class="line">    <span class="type">PackageParser</span> <span class="variable">pp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PackageParser</span>();</span><br><span class="line">    <span class="keyword">final</span> PackageParser.Package pkg;</span><br><span class="line">    <span class="comment">//1、解析APK</span></span><br><span class="line">    pkg = pp.parsePackage(tmpPackageFile, parseFlags);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2、检查apk是否安装过，安装过直接获取一些信息</span></span><br><span class="line">    <span class="keyword">if</span> ((installFlags &amp; PackageManager.INSTALL_REPLACE_EXISTING) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pkg.mOriginalPackages != <span class="literal">null</span> &amp;&amp; pkg.mOriginalPackages.contains(oldName) &amp;&amp; mPackages.containsKey(oldName)) &#123;</span><br><span class="line">            pkg.setPackageName(oldName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3、查看mSettings中是否有该apk的签名，并检验签名是否正确</span></span><br><span class="line">    <span class="type">PackageSetting</span> <span class="variable">ps</span> <span class="operator">=</span> mSettings.mPackages.get(pkgName);</span><br><span class="line">    <span class="comment">//检验签名</span></span><br><span class="line">    verifySignaturesLP(ps, pkg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4、处理权限信息</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> pkg.permissions.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> N-<span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        PackageParser.<span class="type">Permission</span> <span class="variable">perm</span> <span class="operator">=</span> pkg.permissions.get(i);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5、重命名临时文件</span></span><br><span class="line">    <span class="keyword">if</span> (!args.doRename(res.returnCode, pkg, oldCodePath)) &#123;..&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//6、安装</span></span><br><span class="line">    <span class="keyword">if</span> (replace) &#123;</span><br><span class="line">        <span class="comment">//替换安装</span></span><br><span class="line">        replacePackageLI(pkg, parseFlags, scanFlags | SCAN_REPLACING, args.user, installerPackageName, volumeUuid, res);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//安装新的APK</span></span><br><span class="line">        installNewPackageLI(pkg, parseFlags, scanFlags | SCAN_DELETE_DATA_ON_FAILURES, args.user, installerPackageName, volumeUuid, res);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//7、更新应用程序所属的用户</span></span><br><span class="line">    res.newUsers = ps.queryInstalledUsers(sUserManager.getUserIds(), <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="3-4-installNewPackageLIF-解析新app的四大组件等信息"><a href="#3-4-installNewPackageLIF-解析新app的四大组件等信息" class="headerlink" title="3.4 installNewPackageLIF()解析新app的四大组件等信息"></a><span id="jump3_4"/>3.4 installNewPackageLIF()解析新app的四大组件等信息</h2><p>主要工作：</p>
<ul>
<li>1、scanPackageLI()扫描新app下的Activity等四大组件信息</li>
<li>2、更新mSettings信息：即app的权限、签名等等</li>
<li>3、安装失败就删除信息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">installNewPackageLI</span><span class="params">(PackageParser.Package pkg, <span class="type">int</span> parseFlags, <span class="type">int</span> scanFlags,</span></span><br><span class="line"><span class="params">                                 UserHandle user, String installerPackageName, String volumeUuid,</span></span><br><span class="line"><span class="params">                                 PackageInstalledInfo res)</span> &#123;</span><br><span class="line">    <span class="comment">//1、扫描新app下的Activity等四大组件信息</span></span><br><span class="line">    PackageParser.<span class="type">Package</span> <span class="variable">newPackage</span> <span class="operator">=</span> scanPackageLI(pkg, parseFlags, scanFlags, System.currentTimeMillis(), user);</span><br><span class="line">    <span class="comment">//2、更新mSettings信息：即app的权限、签名等等</span></span><br><span class="line">    updateSettingsLI(newPackage, installerPackageName, volumeUuid, <span class="literal">null</span>, <span class="literal">null</span>, res, user);</span><br><span class="line">    <span class="comment">//3、安装失败就删除信息</span></span><br><span class="line">    <span class="keyword">if</span> (res.returnCode != PackageManager.INSTALL_SUCCEEDED) &#123;</span><br><span class="line">        deletePackageLI(pkgName, UserHandle.ALL, <span class="literal">false</span>, <span class="literal">null</span>, <span class="literal">null</span>,dataDirExists ? PackageManager.DELETE_KEEP_DATA : <span class="number">0</span>, res.removedInfo, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.Package <span class="title function_">scanPackageLI</span><span class="params">(..)</span> <span class="keyword">throws</span> PackageManagerException &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageParser.<span class="type">Package</span> <span class="variable">res</span> <span class="operator">=</span> scanPackageDirtyLI(pkg, parseFlags, scanFlags,</span><br><span class="line">                currentTime, user);</span><br><span class="line">        success = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里就又走到PMS启动时的那个扫描流程了，</p>
<ul>
<li>开始解析app的四大组件信息存储到mActivitys等数组中；</li>
</ul>
<h1 id="四、adb、界面安装APK的区别"><a href="#四、adb、界面安装APK的区别" class="headerlink" title="四、adb、界面安装APK的区别"></a><span id="jump4"/>四、adb、界面安装APK的区别</h1><p>adb不用说了，直接就走命令了；</p>
<p>界面我们说一下</p>
<h2 id="4-1-通过intent调起App安装"><a href="#4-1-通过intent调起App安装" class="headerlink" title="4.1 通过intent调起App安装"></a><span id="jump4_1"/>4.1 通过intent调起App安装</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_VIEW);</span><br><span class="line">intent.setDataAndType(xxxxx, <span class="string">&quot;application/vnd.android.package-archive&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="4-2-跳转到InstallStart的Activity中，根据入参是否为uri，进行Android版本区分处理"><a href="#4-2-跳转到InstallStart的Activity中，根据入参是否为uri，进行Android版本区分处理" class="headerlink" title="4.2 跳转到InstallStart的Activity中，根据入参是否为uri，进行Android版本区分处理"></a><span id="jump4_2"/>4.2 跳转到InstallStart的Activity中，根据入参是否为uri，进行Android版本区分处理</h2><p>Intent的Action属性为ACTION_VIEW，Type属性指定Intent的数据类型为application&#x2F;vnd.android.package-archive。<br>能隐式匹配的Activity为InstallStart</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;.InstallStart&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:excludeFromRecents</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">intent-filter</span> <span class="attr">android:priority</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.VIEW&quot;</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.INSTALL_PACKAGE&quot;</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:scheme</span>=<span class="string">&quot;file&quot;</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:scheme</span>=<span class="string">&quot;content&quot;</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:mimeType</span>=<span class="string">&quot;application/vnd.android.package-archive&quot;</span> /&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#packages/apps/PackageInstaller/src/com/android/packageinstaller/InstallStart.java</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">     <span class="comment">//判断Uri的Scheme协议是否是content</span></span><br><span class="line">      <span class="keyword">if</span> (packageUri.getScheme().equals(SCHEME_CONTENT)) &#123;<span class="comment">//3</span></span><br><span class="line">          nextActivity.setClass(<span class="built_in">this</span>, InstallStaging.class);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          nextActivity.setClass(<span class="built_in">this</span>, PackageInstallerActivity.class);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (nextActivity != <span class="literal">null</span>) &#123;</span><br><span class="line">          startActivity(nextActivity);</span><br><span class="line">      &#125;</span><br><span class="line">      finish();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>主要作用：</p>
<ul>
<li>大于Android7.0，使用FileProvider来处理URI，就是content的Scheme协议</li>
<li>小于Android7.0，会走另一个分支PackageInstallerActivity</li>
</ul>
<p>在InstallStaging的类型中，</p>
<ul>
<li>主要就是通过URI再获取到路径，然后还是会跳PackageInstallerActivity，</li>
<li>所以我们直接看PackageInstallerActivity</li>
</ul>
<h2 id="4-3-PackageInstallerActivity真实安装的页面"><a href="#4-3-PackageInstallerActivity真实安装的页面" class="headerlink" title="4.3 PackageInstallerActivity真实安装的页面"></a><span id="jump4_3"/>4.3 PackageInstallerActivity真实安装的页面</h2><p>从功能上来说，PackageInstallerActivity才是应用安装器PackageInstaller真正的入口Activity，PackageInstallerActivity的onCreate方法如下所示。</p>
<h3 id="4-3-1-判断是否能弹出安装页面，不能展示可以展示弹框或者跳设置页"><a href="#4-3-1-判断是否能弹出安装页面，不能展示可以展示弹框或者跳设置页" class="headerlink" title="4.3.1 判断是否能弹出安装页面，不能展示可以展示弹框或者跳设置页"></a><span id="jump4_3_1"/>4.3.1 判断是否能弹出安装页面，不能展示可以展示弹框或者跳设置页</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#packages/apps/PackageInstaller/src/com/android/packageinstaller/PackageInstallerActivity.java</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle icicle)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(icicle);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//1、根据Uri的Scheme进行预处理</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">wasSetUp</span> <span class="operator">=</span> processPackageUri(packageUri);<span class="comment">//1</span></span><br><span class="line">    <span class="comment">//展示UI</span></span><br><span class="line">    bindUi(R.layout.install_confirm, <span class="literal">false</span>);</span><br><span class="line">    <span class="comment">//2、判断是否是未知来源的应用，如果开启允许安装未知来源选项则直接初始化安装</span></span><br><span class="line">    checkIfAllowedAndInitiateInstall();<span class="comment">//2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>1、如果开发者打开允许安装未知来源apk，可直接安装</li>
<li>2、否则展示弹框，或者跳转到设置中开启允许安装<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">checkIfAllowedAndInitiateInstall</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">//判断如果允许安装未知来源或者根据Intent判断得出该APK不是未知来源</span></span><br><span class="line">       <span class="keyword">if</span> (mAllowUnknownSources || !isInstallRequestFromUnknownSource(getIntent())) &#123;<span class="comment">//1</span></span><br><span class="line">           <span class="comment">//初始化安装</span></span><br><span class="line">           initiateInstall();<span class="comment">//2</span></span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">// 如果管理员限制来自未知源的安装, 就弹出提示Dialog或者跳转到设置界面</span></span><br><span class="line">       <span class="keyword">if</span> (isUnknownSourcesDisallowed()) &#123;</span><br><span class="line">           <span class="keyword">if</span> ((mUserManager.getUserRestrictionSource(UserManager.DISALLOW_INSTALL_UNKNOWN_SOURCES,</span><br><span class="line">                   Process.myUserHandle()) &amp; UserManager.RESTRICTION_SOURCE_SYSTEM) != <span class="number">0</span>) &#123;    </span><br><span class="line">               showDialogInner(DLG_UNKNOWN_SOURCES_RESTRICTED_FOR_USER);</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               startActivity(<span class="keyword">new</span> <span class="title class_">Intent</span>(Settings.ACTION_SHOW_ADMIN_SUPPORT_DETAILS));</span><br><span class="line">               finish();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           handleUnknownSources();<span class="comment">//3</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="4-3-2-initiateInstall-初始化安装页面"><a href="#4-3-2-initiateInstall-初始化安装页面" class="headerlink" title="4.3.2 initiateInstall() 初始化安装页面"></a><span id="jump4_3_2"/>4.3.2 initiateInstall() 初始化安装页面</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initiateInstall</span><span class="params">()</span> &#123;</span><br><span class="line">    ..</span><br><span class="line">  <span class="comment">//初始化安装确认界面</span></span><br><span class="line">  startInstallConfirm();<span class="comment">//3</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startInstallConfirm</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//省略初始化界面代码</span></span><br><span class="line">     ...</span><br><span class="line">     <span class="comment">//展示apk权限列表等等</span></span><br><span class="line">     <span class="type">AppSecurityPermissions</span> <span class="variable">perms</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AppSecurityPermissions</span>(<span class="built_in">this</span>, mPkgInfo);</span><br><span class="line">     mScrollView = <span class="keyword">new</span> <span class="title class_">CaffeinatedScrollView</span>(<span class="built_in">this</span>);</span><br><span class="line">     ...</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-3-3-onClick-用户点击同意安装，跳转至InstallInstalling的Activity中处理"><a href="#4-3-3-onClick-用户点击同意安装，跳转至InstallInstalling的Activity中处理" class="headerlink" title="4.3.3 onClick()用户点击同意安装，跳转至InstallInstalling的Activity中处理"></a><span id="jump4_3_3"/>4.3.3 onClick()用户点击同意安装，跳转至InstallInstalling的Activity中处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    startInstall();<span class="comment">//1</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startInstall</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Intent</span> <span class="variable">newIntent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">    newIntent.putExtra(PackageUtil.INTENT_ATTR_APPLICATION_INFO, mPkgInfo.applicationInfo);</span><br><span class="line">    <span class="comment">//跳转到InstallInstalling的Activity中去了</span></span><br><span class="line">    newIntent.setClass(<span class="built_in">this</span>, InstallInstalling.class);</span><br><span class="line">    ...</span><br><span class="line">    startActivity(newIntent);</span><br><span class="line">    finish();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-4-InstallInstalling的Activity通过PackageInstallerSession和PMS通信"><a href="#4-4-InstallInstalling的Activity通过PackageInstallerSession和PMS通信" class="headerlink" title="4.4 InstallInstalling的Activity通过PackageInstallerSession和PMS通信"></a><span id="jump4_4"/>4.4 InstallInstalling的Activity通过PackageInstallerSession和PMS通信</h2><p>注意这个是InstallInstalling，和上边区分Android版本的那个不是一个类哈；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onResume</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onResume();</span><br><span class="line">    <span class="comment">//1、执行安装异步任务</span></span><br><span class="line">    mInstallingTask = <span class="keyword">new</span> <span class="title class_">InstallingAsyncTask</span>();</span><br><span class="line">    mInstallingTask.execute();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//2、InstallingAsyncTask会执行至此</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onPostExecute</span><span class="params">(PackageInstaller.Session session)</span> &#123;</span><br><span class="line">    <span class="comment">//PackageInstaller.Session 中持有IPackageInstallerSession，就是PackageInstaller的BinderProxy，</span></span><br><span class="line">    <span class="comment">//这里就是扩进程通过binder，调用至PackageInstaller服务中去了</span></span><br><span class="line">    session.commit(pendingIntent.getIntentSender());<span class="comment">//1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PackageInstallerSession 并不是在 PMS 启动时自动启动的服务，而是由 PackageInstaller 创建和管理的会话对象。</p>
<h2 id="4-5-调用至PMS服务中-installStage-中"><a href="#4-5-调用至PMS服务中-installStage-中" class="headerlink" title="4.5 调用至PMS服务中.installStage()中"></a><span id="jump4_5"/>4.5 调用至PMS服务中.installStage()中</h2><p>PackageInstallerSession是PMS服务的会话对象，所以这里已经到PMS服务中了；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#frameworks/base/services/core/java/com/android/server/pm/PackageInstallerSession.java</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">commit</span><span class="params">(IntentSender statusReceiver)</span> &#123;</span><br><span class="line">   Preconditions.checkNotNull(statusReceiver);</span><br><span class="line">   ...</span><br><span class="line">   <span class="comment">//1、发送到PMS的Handler处理</span></span><br><span class="line">   mHandler.obtainMessage(MSG_COMMIT, adapter.getBinder()).sendToTarget();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Handler.<span class="type">Callback</span> <span class="variable">mHandlerCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Handler</span>.Callback() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">handleMessage</span><span class="params">(Message msg)</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">//2、继续调用</span></span><br><span class="line">      commitLocked(pkgInfo, appInfo);<span class="comment">//2</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">commitLocked</span><span class="params">(PackageInfo pkgInfo, ApplicationInfo appInfo)</span> <span class="keyword">throws</span> PackageManagerException &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//3、调用至安装方法</span></span><br><span class="line">    mPm.installStage(mPackageName, stageDir, stageCid, localObserver, params,</span><br><span class="line">      installerPackageName, installerUid, user, mCertificates);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a><span id="jump5"/>五、总结</h1><h2 id="（1）安装过程完整流程图"><a href="#（1）安装过程完整流程图" class="headerlink" title="（1）安装过程完整流程图"></a><span id="jump5_1"/>（1）安装过程完整流程图</h2><p><img src="https://raw.githubusercontent.com/IRVING18/pic/master/Framework%E7%B3%BB%E7%BB%9F%E7%AF%877-PackageManagerService(PMS)3-%E5%AE%89%E8%A3%85APK%E8%BF%87%E7%A8%8B_1.jpg" alt="PMS安装过程.png"></p>
<h2 id="（2）页面安装的核心Activity"><a href="#（2）页面安装的核心Activity" class="headerlink" title="（2）页面安装的核心Activity"></a><span id="jump5_2"/>（2）页面安装的核心Activity</h2><ul>
<li>由Intent匹配固定的application&#x2F;vnd.android.package-archive找到InstallStart；</li>
<li>1、InstallStart是个Activity<ul>
<li>作用是分别处理Android7.0前后，入参的问题</li>
<li>大于 7.0 跳InstallStaging.class </li>
<li>小于 7.0 跳PackageInstallerActivity</li>
</ul>
</li>
<li>2、InstallStaging也是Activity<ul>
<li>作用就是7.0之后兼容URI入参，转成路径之后还会跳PackageInstallerActivity</li>
</ul>
</li>
<li>3、PackageInstallerActivity<ul>
<li>判断是否能安装APK，不能安装可以弹dialog提醒（类似小米改app不能安装应用“允许本次”的弹框）</li>
</ul>
</li>
<li>4、InstallInstalling也是Activity<ul>
<li>作用是展示安装页面的Activity；</li>
<li>当onClick()点击安装后，会通过PackageInstallerSession跨进程通信调度至PMS中.installStage()开始安装流程</li>
</ul>
</li>
</ul>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a><span id="jump"/>参考文档</h1><ul>
<li><a target="_blank" rel="noopener" href="https://liuwangshu.cn/framework/pms/1-packageinstaller-initialize.html">https://liuwangshu.cn/framework/pms/1-packageinstaller-initialize.html</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903637731246087#heading-2">https://juejin.cn/post/6844903637731246087#heading-2</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://irving18.github.io">王征</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://irving18.github.io/2024/08/24/Framework%E7%B3%BB%E7%BB%9F%E7%AF%877-PackageManagerService(PMS)3-%E5%AE%89%E8%A3%85APK%E8%BF%87%E7%A8%8B/">https://irving18.github.io/2024/08/24/Framework%E7%B3%BB%E7%BB%9F%E7%AF%877-PackageManagerService(PMS)3-%E5%AE%89%E8%A3%85APK%E8%BF%87%E7%A8%8B/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://irving18.github.io" target="_blank">Android高级直通车</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android%E8%BF%9B%E9%98%B6/">Android进阶</a><a class="post-meta__tags" href="/tags/Framework/">Framework</a><a class="post-meta__tags" href="/tags/%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1/">系统服务</a><a class="post-meta__tags" href="/tags/PMS/">PMS</a></div><div class="post-share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat_pay.png" target="_blank"><img class="post-qr-code-img" src="/img/wechat_pay.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2024/08/27/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-BroadCast%E4%BD%BF%E7%94%A8/" title="Framework四大组件篇-BroadCast使用"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Framework四大组件篇-BroadCast使用</div></div><div class="info-2"><div class="info-item-1">目录 一、广播接收 （1）静态注册 （2）动态注册 （3）接收优先级 （4）前台广播、后台广播   二、广播发送 （1）无序广播 （2）有序广播 给下游传输数据、中断广播   （3）粘性广播（异步广播） （4）粘性有序广播 （5）前台广播、后台广播   三、常用系统广播汇总 （1）开机广播 （2）网络状态广播 （3）电量变化   四、Interview常见问题 （1）广播的超时时间 （2）广播中想做耗时操作，应该怎么搞？    一、广播接收定义一个默认广播，用于接收广播消息； 12345678910111213class MyBroadCast : BroadcastReceiver() &#123;    companion object &#123;        val WZ_RECEIVER = &quot;com.wz.test.MyTestBroadCast&quot;    &#125;    override fun onReceive(context: Context, intent: Intent) &#123;       ...</div></div></div></a><a class="pagination-related" href="/2024/08/02/Framework%E7%B3%BB%E7%BB%9F%E7%AF%877-PackageManagerService(PMS)2-%E8%8E%B7%E5%8F%96Activity%E4%BF%A1%E6%81%AF/" title="Framework系统篇7-PackageManagerService(PMS)2-获取Activity信息"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Framework系统篇7-PackageManagerService(PMS)2-获取Activity信息</div></div><div class="info-2"><div class="info-item-1">目录 完整的PMS启动，Activity获取流程图 一、PMS在Activity启动中的作用前述，通过Intent获取ActivityInfo 1、Instrumentation调度execStartActivity() 2、调用至AMS.startActivity()中 3、调用至ActivityStack.startActivityMayWait()中 4、调用ActivityStack.resolveActivity()获取ActivityInfo 5、调用至PMS.resolveIntent()获取ActivityInfo   二、PMS.resolveIntent()获取PMS启动时存储的mActvities、mSetttings的信息 1、PMS.resolveIntent() 2、PMS.queryIntentActivities() 获取ActivityInfo信息 3、PMS.getActivityInfo() mActivities中获取类名、filter规则等信息 &amp;...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2024/07/24/Framework%E7%B3%BB%E7%BB%9F%E7%AF%877-PackageManagerService(PMS)1-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/" title="Framework系统篇7-PackageManagerService(PMS)1-启动过程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-24</div><div class="info-item-2">Framework系统篇7-PackageManagerService(PMS)1-启动过程</div></div><div class="info-2"><div class="info-item-1">目录 完整的PMS启动、Activity获取的流程图 一、前述 1.1 先了解下PMS的作用 1.2 从SystemServer进程调度PMS启动 1.2.1 运行SystemServer.run()方法 1.2.2 在startBootstrapServices()中启动PMS.main() 1.2.3 在startOtherServices()中继续调用PMS核心方法：performBootDexOpt()、systemReady()     二、PMS.main()启动 2.1 开始阶段（PMS_START）创建Settings保存app安装信息等，开启文件目录 2.1.1 Settings：用于保存所有app的安装信息等 2.1.2 SystemConfig：存储应用的权限等信息，如系统应用等 2.1.3 在Data分区创建一些目录：如&#x2F;data&#x2F;data 等   2.2 扫描系统阶段（PMS_SYSTEM_SCAN_START）读取系统app、Framework文件 2.3...</div></div></div></a><a class="pagination-related" href="/2024/08/02/Framework%E7%B3%BB%E7%BB%9F%E7%AF%877-PackageManagerService(PMS)2-%E8%8E%B7%E5%8F%96Activity%E4%BF%A1%E6%81%AF/" title="Framework系统篇7-PackageManagerService(PMS)2-获取Activity信息"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-08-02</div><div class="info-item-2">Framework系统篇7-PackageManagerService(PMS)2-获取Activity信息</div></div><div class="info-2"><div class="info-item-1">目录 完整的PMS启动，Activity获取流程图 一、PMS在Activity启动中的作用前述，通过Intent获取ActivityInfo 1、Instrumentation调度execStartActivity() 2、调用至AMS.startActivity()中 3、调用至ActivityStack.startActivityMayWait()中 4、调用ActivityStack.resolveActivity()获取ActivityInfo 5、调用至PMS.resolveIntent()获取ActivityInfo   二、PMS.resolveIntent()获取PMS启动时存储的mActvities、mSetttings的信息 1、PMS.resolveIntent() 2、PMS.queryIntentActivities() 获取ActivityInfo信息 3、PMS.getActivityInfo() mActivities中获取类名、filter规则等信息 &amp;...</div></div></div></a><a class="pagination-related" href="/2024/07/08/Framework%E7%B3%BB%E7%BB%9F%E7%AF%871-Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" title="Framework系统篇1-Android系统启动流程"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-08</div><div class="info-item-2">Framework系统篇1-Android系统启动流程</div></div><div class="info-2"><div class="info-item-1">[toc]                                            一、系统启动入口 简图中我们关注的重点：  1、core、main、late-start三种类型任务 2、与AMS类似的系统进程是通过servicemanager来获取IBinder对象，从而得到BpBinder，进而通过binder来通信的 3、普通应用间，是通过Service组件，来获取IBinder对象，从而得到BpBinder，进程通过binder来通信的；    &#x2F;system&#x2F;core&#x2F;init&#x2F;init.cpp&#x2F;system&#x2F;core&#x2F;rootdir&#x2F;init.rc  （一）init.rc：标识core、main、late_start类型服务 12345678910111213141516#6.0以前的源码//1、Linux以服务形式启动ServiceManagerservice servicemanager /system/bin/servicemanager   ...</div></div></div></a><a class="pagination-related" href="/2024/07/09/Framework%E7%B3%BB%E7%BB%9F%E7%AF%872-ActivityManagerService(AMS)%E5%90%AF%E5%8A%A8%E7%AF%87/" title="Framework系统篇2-ActivityManagerService(AMS)启动篇"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-09</div><div class="info-item-2">Framework系统篇2-ActivityManagerService(AMS)启动篇</div></div><div class="info-2"><div class="info-item-1">[toc] 一、前述在【Fw-系统启动流程】中已经知道，SystemServer进程的run()方法：  1、startBootstrapServices(); 启动引导服务：AMS、PMS、PowerManagerServic 2、startCoreServices(); 启动核心服务：BatteryService 3、startOtherServices(); 启动其他服务：如WMS  这其中还会调用startBootPhase() 方法，  1、传入不同的phase [feɪz]...</div></div></div></a><a class="pagination-related" href="/2024/07/10/Framework%E7%B3%BB%E7%BB%9F%E7%AF%873-ActivityManagerService(AMS)%EF%BC%9AActivity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B&%E7%BB%98%E5%88%B6%E9%A1%BA%E5%BA%8F/" title="Framework系统篇3-ActivityManagerService(AMS)：Activity启动流程&amp;绘制顺序"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-10</div><div class="info-item-2">Framework系统篇3-ActivityManagerService(AMS)：Activity启动流程&amp;绘制顺序</div></div><div class="info-2"><div class="info-item-1">目录 前述、简述系统启动流程  简图 tips 1、为什么和zygoet通信是Socket呢？ 2、如果是多线程操作时，fork会有问题？     一、Activity启动流程  （1）简化启动App的Activity的流程 （2）Activity整体启动过程   二、Zygoet fork进程  （1）runSelectLoop轮询 （2）fork进程 （3）handleChildProc 调用新进程初始化方法 （4）ActivityThread.main   三、Activity绘制流程  完整流程图 （1）handleLaunchActivity：Window创建 1、onAttach： window创建(即PhoneWindow) WindowManagerImpl创建，并持有mGlobal(即WindowManagerGlobal)   2、onCreate：DecorView创建   （2）handleResumeActivity：mGlobal.add() 0、先执行onResume()回调 1、mGlobal.add(decorview) 并创建root...</div></div></div></a><a class="pagination-related" href="/2024/07/16/Framework%E7%B3%BB%E7%BB%9F%E7%AF%874-WindowManagerService(WMS)2%EF%BC%9A%E5%90%AF%E5%8A%A8%E7%AF%87/" title="Framework系统篇4-WindowManagerService(WMS)2：启动篇"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-16</div><div class="info-item-2">Framework系统篇4-WindowManagerService(WMS)2：启动篇</div></div><div class="info-2"><div class="info-item-1">[toc] 一、概述（1）WMS、Surface、SurfaceFlinger关系WMS核心关系：  Surface: 代表画布 WMS: 添加window的过程主要功能是添加Surface,管理所有的Surface布局,以及Z轴排序问题; SurfaceFinger: 将Surface按次序混合并显示到物理屏幕上;  （2）WMS整体认识  一、WMS端： WMS继承于IWindowManager.Stub, 作为Binder服务端; WMS的成员变量mSessions保存着所有的Session对象,Session继承于IWindowSession.Stub, 作为Binder服务端; 成员变量mPolicy: 实例对象为PhoneWindowManager,用于实现各种窗口相关的策略; 成员变量mChoreographer: 用于控制窗口动画,屏幕旋转等操作; 成员变量mDisplayContents: 记录一组DisplayContent对象,这个跟多屏输出相关; 成员变量mTokenMap: 保存所有的WindowToken对象;...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">王征</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">41</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">18</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/IRVING18"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="mailto:ivring18@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"><span>Android开发者迈向<span style="color:red; weight:bold" >高级Android开发</span>的直通车，总结了各大面试考点！<span></br><span>一个通人性的博主，码字不易，用爱发电。希望大家多多支持。</span><img width="250px" src="/img/wechat_pay.png"></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95"><span class="toc-number">1.</span> <span class="toc-text">目录</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81PackageHandler%E5%A4%84%E7%90%86%E5%AE%89%E8%A3%85%E6%B6%88%E6%81%AF"><span class="toc-number">2.</span> <span class="toc-text">一、PackageHandler处理安装消息</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-PMS-installStage"><span class="toc-number">2.1.</span> <span class="toc-text">1.1 PMS.installStage()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-PackageHandler%E5%A4%84%E7%90%86INIT-COPY%E6%B6%88%E6%81%AF"><span class="toc-number">2.2.</span> <span class="toc-text">1.2 PackageHandler处理INIT_COPY消息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-connectToService-%E5%90%AF%E5%8A%A8DefaultContainerService%E6%9C%8D%E5%8A%A1%EF%BC%88%E7%94%A8%E4%BA%8E%E6%A3%80%E6%9F%A5%E5%92%8C%E5%A4%8D%E5%88%B6%E5%8F%AF%E7%A7%BB%E5%8A%A8%E6%96%87%E4%BB%B6%E7%9A%84%E6%9C%8D%E5%8A%A1%EF%BC%89"><span class="toc-number">2.2.1.</span> <span class="toc-text">1.2.1 connectToService()启动DefaultContainerService服务（用于检查和复制可移动文件的服务）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-%E7%BB%91%E5%AE%9A%E6%9C%8D%E5%8A%A1%E5%90%8E%EF%BC%8C%E7%BB%A7%E7%BB%AD%E5%8F%91%E9%80%81MCS-BOUND%E6%B6%88%E6%81%AF%EF%BC%8C%E5%A4%84%E7%90%86%E5%AE%89%E8%A3%85"><span class="toc-number">2.2.2.</span> <span class="toc-text">1.2.2 绑定服务后，继续发送MCS_BOUND消息，处理安装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-PackageHandler%E5%A4%84%E7%90%86MCS-BOUND%E6%B6%88%E6%81%AF"><span class="toc-number">2.3.</span> <span class="toc-text">1.3 PackageHandler处理MCS_BOUND消息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-1-%E5%AE%89%E8%A3%85%E5%B0%9D%E8%AF%95%E6%AC%A1%E6%95%B0-4%E6%AC%A1%EF%BC%8C%E5%B0%B1%E6%94%BE%E5%BC%83%E5%AE%89%E8%A3%85"><span class="toc-number">2.3.1.</span> <span class="toc-text">1.3.1 安装尝试次数&gt;4次，就放弃安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-2-handleStartCopy-%EF%BC%8C%E5%BC%80%E5%A7%8B%E5%A4%8D%E5%88%B6%E6%B5%81%E7%A8%8B"><span class="toc-number">2.3.2.</span> <span class="toc-text">1.3.2 handleStartCopy()，开始复制流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-3-handleReturnCode-%EF%BC%8C%E5%BC%80%E5%A7%8B%E5%AE%89%E8%A3%85%E6%B5%81%E7%A8%8B"><span class="toc-number">2.3.3.</span> <span class="toc-text">1.3.3 handleReturnCode()，开始安装流程</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E5%A4%8D%E5%88%B6apk"><span class="toc-number">3.</span> <span class="toc-text">二、复制apk</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-PMS-handleStartCopy-%E5%A4%8D%E5%88%B6APK"><span class="toc-number">3.1.</span> <span class="toc-text">2.1 PMS.handleStartCopy()复制APK</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-FileInstallArgs-copyApk-mContainerService-%E5%8F%91%E9%80%81%E8%87%B3mContainerService%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.2.</span> <span class="toc-text">2.2 FileInstallArgs.copyApk(mContainerService)发送至mContainerService服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-IMediaContainerService%E8%B7%A8%E8%BF%9B%E7%A8%8B%E8%B0%83%E7%94%A8DefaultContainerService%E7%9A%84copyPackage%E6%96%B9%E6%B3%95"><span class="toc-number">3.3.</span> <span class="toc-text">2.3 IMediaContainerService跨进程调用DefaultContainerService的copyPackage方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%AE%89%E8%A3%85APK"><span class="toc-number">4.</span> <span class="toc-text">三、安装APK</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-PMS-handleReturnCode"><span class="toc-number">4.1.</span> <span class="toc-text">3.1 PMS.handleReturnCode()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-PMS-processPendingInstall"><span class="toc-number">4.2.</span> <span class="toc-text">3.2 PMS.processPendingInstall()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-PMS-installPackageLI-%E8%A7%A3%E6%9E%90apk%E5%AE%89%E8%A3%85"><span class="toc-number">4.3.</span> <span class="toc-text">3.3 PMS.installPackageLI()解析apk安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-installNewPackageLIF-%E8%A7%A3%E6%9E%90%E6%96%B0app%E7%9A%84%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AD%89%E4%BF%A1%E6%81%AF"><span class="toc-number">4.4.</span> <span class="toc-text">3.4 installNewPackageLIF()解析新app的四大组件等信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81adb%E3%80%81%E7%95%8C%E9%9D%A2%E5%AE%89%E8%A3%85APK%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">5.</span> <span class="toc-text">四、adb、界面安装APK的区别</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E9%80%9A%E8%BF%87intent%E8%B0%83%E8%B5%B7App%E5%AE%89%E8%A3%85"><span class="toc-number">5.1.</span> <span class="toc-text">4.1 通过intent调起App安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-%E8%B7%B3%E8%BD%AC%E5%88%B0InstallStart%E7%9A%84Activity%E4%B8%AD%EF%BC%8C%E6%A0%B9%E6%8D%AE%E5%85%A5%E5%8F%82%E6%98%AF%E5%90%A6%E4%B8%BAuri%EF%BC%8C%E8%BF%9B%E8%A1%8CAndroid%E7%89%88%E6%9C%AC%E5%8C%BA%E5%88%86%E5%A4%84%E7%90%86"><span class="toc-number">5.2.</span> <span class="toc-text">4.2 跳转到InstallStart的Activity中，根据入参是否为uri，进行Android版本区分处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-PackageInstallerActivity%E7%9C%9F%E5%AE%9E%E5%AE%89%E8%A3%85%E7%9A%84%E9%A1%B5%E9%9D%A2"><span class="toc-number">5.3.</span> <span class="toc-text">4.3 PackageInstallerActivity真实安装的页面</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E8%83%BD%E5%BC%B9%E5%87%BA%E5%AE%89%E8%A3%85%E9%A1%B5%E9%9D%A2%EF%BC%8C%E4%B8%8D%E8%83%BD%E5%B1%95%E7%A4%BA%E5%8F%AF%E4%BB%A5%E5%B1%95%E7%A4%BA%E5%BC%B9%E6%A1%86%E6%88%96%E8%80%85%E8%B7%B3%E8%AE%BE%E7%BD%AE%E9%A1%B5"><span class="toc-number">5.3.1.</span> <span class="toc-text">4.3.1 判断是否能弹出安装页面，不能展示可以展示弹框或者跳设置页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2-initiateInstall-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%89%E8%A3%85%E9%A1%B5%E9%9D%A2"><span class="toc-number">5.3.2.</span> <span class="toc-text">4.3.2 initiateInstall() 初始化安装页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-3-onClick-%E7%94%A8%E6%88%B7%E7%82%B9%E5%87%BB%E5%90%8C%E6%84%8F%E5%AE%89%E8%A3%85%EF%BC%8C%E8%B7%B3%E8%BD%AC%E8%87%B3InstallInstalling%E7%9A%84Activity%E4%B8%AD%E5%A4%84%E7%90%86"><span class="toc-number">5.3.3.</span> <span class="toc-text">4.3.3 onClick()用户点击同意安装，跳转至InstallInstalling的Activity中处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-InstallInstalling%E7%9A%84Activity%E9%80%9A%E8%BF%87PackageInstallerSession%E5%92%8CPMS%E9%80%9A%E4%BF%A1"><span class="toc-number">5.4.</span> <span class="toc-text">4.4 InstallInstalling的Activity通过PackageInstallerSession和PMS通信</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-%E8%B0%83%E7%94%A8%E8%87%B3PMS%E6%9C%8D%E5%8A%A1%E4%B8%AD-installStage-%E4%B8%AD"><span class="toc-number">5.5.</span> <span class="toc-text">4.5 调用至PMS服务中.installStage()中</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">五、总结</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E5%AE%89%E8%A3%85%E8%BF%87%E7%A8%8B%E5%AE%8C%E6%95%B4%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">6.1.</span> <span class="toc-text">（1）安装过程完整流程图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E9%A1%B5%E9%9D%A2%E5%AE%89%E8%A3%85%E7%9A%84%E6%A0%B8%E5%BF%83Activity"><span class="toc-number">6.2.</span> <span class="toc-text">（2）页面安装的核心Activity</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="toc-number">7.</span> <span class="toc-text">参考文档</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/20/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-Service%EF%BC%9AstartService%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="Framework四大组件篇-Service：startService源码分析">Framework四大组件篇-Service：startService源码分析</a><time datetime="2024-09-20T07:40:47.000Z" title="发表于 2024-09-20 15:40:47">2024-09-20</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/17/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-Service%EF%BC%9AbindService%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="Framework四大组件篇-Service：bindService源码分析">Framework四大组件篇-Service：bindService源码分析</a><time datetime="2024-09-17T07:40:36.000Z" title="发表于 2024-09-17 15:40:36">2024-09-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/16/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-Service1%E4%BD%BF%E7%94%A8%E7%AF%87/" title="Framework四大组件篇-Service1使用篇">Framework四大组件篇-Service1使用篇</a><time datetime="2024-09-16T07:40:35.000Z" title="发表于 2024-09-16 15:40:35">2024-09-16</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/09/07/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-ContentProvider%E5%90%AF%E5%8A%A8%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="Framework四大组件篇-ContentProvider启动源码分析">Framework四大组件篇-ContentProvider启动源码分析</a><time datetime="2024-09-07T07:39:36.000Z" title="发表于 2024-09-07 15:39:36">2024-09-07</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/30/Framework%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E7%AF%87-BroadCast%E5%8E%9F%E7%90%86%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" title="Framework四大组件篇-BroadCast原理源码分析">Framework四大组件篇-BroadCast原理源码分析</a><time datetime="2024-08-30T07:40:05.000Z" title="发表于 2024-08-30 15:40:05">2024-08-30</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/bg.png);"><div id="footer-wrap"><div class="copyright">&copy;2024 By 王征</div><div class="footer_custom_text"><a href=""><img class="icp-icon" src="/img/avatar.jpg"><span>一个通人性的博主</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>